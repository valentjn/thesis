\section{Implementation and Numerical Results}
\label{sec:84results}

\minitoc[3mm]{65mm}{6}

\parbox{1em}{}
\vspace{-3em}



\printornamentsfalse
\subsection{Implementation}
\label{sec:841implementation}
\printornamentstrue

\paragraph{Parameter values and basis functions}

We use
a risk aversion factor of $\riskav = 3.5$,
a patience factor of $\patience = 0.97$,
a transaction cost rate of $\tac = \SI{1}{\percent}$, and
a minimum consumption of $\normconsume_{\min} = 0.001$.
The bond and stock return rates $\bondreturn_t$ and $\vstockreturn_t$
are taken from \cite{Cai10Stable};
the log-normally distributed stock return rates are generalized
from the three-stock case to five stocks via
$\ln \vstockreturn_t \sim \mathcal{N}(\*\mu, \mat{\Sigma})$, where
{%
  \setlength{\abovedisplayskip}{6pt}%
  \setlength{\belowdisplayskip}{6pt}%
  \begin{equation}
    \label{eq:financeStockReturnMeanCovariance}
    \*\mu
    :=
    \scalebox{0.92}{$
      \begin{pmatrix*}[l]
        0.0572\\
        0.0638\\
        0.07\\
        0.0764\\
        0.0828
      \end{pmatrix*}
    $},\quad
    \mat{\Sigma}
    := 10^{-2}
    \scalebox{0.92}{$
      \begin{pmatrix*}[l]
        2.56&  0.576&   0.288&   0.176&  0.096\\
        0.576& 3.24&    0.90432& 1.0692& 1.296\\
        0.288& 0.90432& 4&       1.32&   1.68\\
        0.176& 1.0692&  1.32&    4.84&   2.112\\
        0.096& 1.296&   1.68&    2.112&  5.76
      \end{pmatrix*}
    $}.
  \end{equation}%
}%
The models are solved for $T = 6$ time steps;
this number suffices to show all relevant numerical effects and results,
while keeping the computational effort at a reasonable level.
As higher-order B-spline basis functions,
we use the hierarchical weakly fundamental not-a-knot splines
$\bspl[\wfs,\nak]{\*l,\*i}{p}$ of cubic degree $p = 3$
to enable hierarchization with the unidirectional principle
(see \cref{sec:454wfs}).
As initial grids, we employ regular sparse grids
$\coarseregsgset{n}{d}{b}$ with $b = 1$
to decrease the number of grid points
(see \cref{sec:241coarseBoundary}).

\vspace*{-0.5em}

\paragraph{Software}

The dynamic portfolio choice models were solved using a self-written
MATLAB framework.
The object-oriented framework was designed in such a way that
not only transaction costs problems,
but many other types of dynamic portfolio choice models can be handled.
For instance, the base class \texttt{LifecycleProblem} provides
an interface with abstract functions such as
\texttt{computeTerminalValueFunction} and
\texttt{computeStateTransition}.
The actual functionality implemented in the base class strongly resembles
the algorithms presented in \cref{sec:82algorithms}.
This is not only desirable from a modeling perspective,
but also facilitates future usage by other researchers.
For creating (hierarchization) and evaluating sparse grid interpolants,
the sparse grid toolbox \sgpp was used \cite{Pflueger10Spatially}.%
\footnote{%
  \url{http://sgpp.sparsegrids.org/}%
}
The emerging optimization problems were solved using
sequential quadratic programming methods supplied by the
NAG Toolbox for MATLAB.%
\footnote{%
  \url{https://www.nag.com/}%
}
To avoid getting stuck in local minima,
we repeat the optimization process for a varying number
of initial multi-start points (in the range of a few dozens).
All runtimes were measured on a shared memory computer
with 144 threads on 4x Intel Xeon E7-8880v3 (72 cores, 144 threads).



\subsection{Error Sources and Error Measure}
\label{sec:842errorSources}

\paragraph{Error sources}

In this application, there are the following error sources:

\begin{enumerate}[
  label=E\arabic*.,
  ref=E\arabic*,
  leftmargin=2.7em,
  itemsep=-0.3em,
]
  \item
  \label{item:financeErrorInterpolationValue}
  Interpolation of the value function
  (i.e., $\normcetvalueintp_{t+1} \not= \normcetvaluefcn_{t+1}$)
  
  \item
  \label{item:financeErrorInterpolationPolicy}
  Interpolation of the policy functions
  (i.e., $\optnormpolicyintp_t \not= \optnormpolicyfcn_t$)
  
  \item
  \label{item:financeErrorExtrapolation}
  Extrapolation errors
  (i.e., $
  \normcetvalueintp_{t+1}(\state_{t+1})
  \not= \normcetvaluefcn_{t+1}(\state_{t+1})
  $)
  
  \item
  \label{item:financeErrorCropping}
  Errors from state space cropping
  (i.e., Euler errors do not vanish for exact solution)
  
  \item
  \label{item:financeErrorOptimization}
  Optimization error
  (i.e., the global minimum found by the optimizer is inaccurate)
  
  \item
  \label{item:financeErrorQuadrature}
  Quadrature error
  ($
  \expectation[t]{\cdots}
  \not= \sum_{j=1}^{m_{\quadweight}} \quadweight_t^{(j)}
  [\cdots](\stochastic_t^{(j)})
  $)
  
  \item
  \label{item:financeErrorRounding}
  Floating-point rounding errors
  (i.e., arithmetical operations are inaccurate)
\end{enumerate}
Due to the dynamic programming scheme,
the combination of all errors accumulates over $t$.
For instance, if the optimization does not find the global optimum
exactly or it only finds a local one for the time $t + 1$,
the error propagates from the interpolant $\normcetvalueintp_{t+1}$
on the right-hand side of the Bellman equation
\eqref{eq:normalizedTCPBellmanEquation} to $\normcetvalueintp_t$
on the left-hand side, and so on.
If the system does not damp these errors,
the error might become larger and larger backwards in time $t$.

\paragraph{Error measure}

We use the weighted Euler equation error
$\weightedeulererror_t(\normstate_t)$ ($\Ltwo$ norm or pointwise)
to assess the quality of the resulting policies.
As the errors generally grow backwards in time,
it suffices to consider $t = 0$.
However, since the Euler equation error can only be evaluated at points in
the simplex
$
  \Omega_\mathrm{simplex}
  := \{\normstate_t \in \clint{\*0, \*1} \mid \sumfcn(\normstate_t) \le 1\}
$, the $\Ltwo$ norm would
quickly converge to zero with growing dimensionality, even if the mean error
stayed constant.
Therefore, we normalize the $\Ltwo$ norm:
\begin{equation}
  \weightedeulererrorLtwo_t
  := \sqrt{d!} \cdot \normLtwo{\weightedeulererror_t}
  = \sqrt{
    \frac{1}{\vol{\Omega_\mathrm{simplex}}}
    \int_{\mathrlap{\Omega_\mathrm{simplex}}\hphantom{\Omega}}
    \weightedeulererror_t(\normstate_t)^2 \diff{}\normstate_t
  },
\end{equation}
where the expression under the root sign is approximated
via Monte Carlo quadrature as the mean of samples
of $\weightedeulererror_t(\normstate_t)^2$.



\subsection{Numerical Results}
\label{sec:843results}

\paragraph{Full grid solution}

We show in \cref{fig:financeSolution2DReference}
a full grid solution for the case of $d = 2$ stocks,
i.e., $\{\state_t^{(k)} \mid k = 1, \dotsc, \ngp_t\} = \fgset{n,d}$
for some fixed level $n \in \nat$
(here, $n = 7$ and $\ngp_t = (2^7 + 1)^2 = \num{16641}$) and
for all $t = 0, \dotsc, T$.
Obviously, this is only computationally feasible
for low dimensionalities $d$ due to the curse of dimensionality.
The two-dimensional solution of level $n = 7$
already took over nine hours to compute.
The solution of the next level is estimated to take already one week.
Full grid solutions can only be computed up to $d = 3$
due to excessive runtime for $d \ge 4$.
This underlines the need for sophisticated
discretization techniques such as sparse grids.

\begin{figure}
  \makebox[49mm][r]{%
    \includegraphics{financeSolution2D_1}%
  }%
  \hfill%
  \makebox[49mm][r]{%
    \includegraphics{financeSolution2D_2}%
  }%
  \hfill%
  \makebox[49mm][r]{%
    \includegraphics{financeSolution2D_4}%
  }%
  \\[0mm]%
  \makebox[49mm][r]{%
    \includegraphics{financeSolution2D_6}%
  }%
  \hfill%
  \makebox[49mm][r]{%
    \includegraphics{financeSolution2D_3}%
  }%
  \hfill%
  \makebox[49mm][r]{%
    \includegraphics{financeSolution2D_5}%
  }%
  \caption[Reference solution for the two-dimensional TCP]{%
    Full grid solution for the transaction costs problem
    with $d = 2$ stocks.
    Shown are the value function $\normcetvalueref_t$ \emph{(top left)} and the
    optimal policy $\optnormpolicyref_t$ for $t = 0$.%
  }%
  \label{fig:financeSolution2DReference}%
\end{figure}

\paragraph{Convergence of the weighted Euler equation error}

\Cref{fig:financeEulerError} shows the convergence of the
$\Ltwo$ norm $\weightedeulererrorLtwo_0$
weighted Euler equation error for $t = 0$ for regular sparse grids
and spatially adaptive sparse grids
for the cases of $d = 1, \dotsc, 4$ stocks.
\begin{figure}
  \includegraphics{financeEulerError_5}%
  \\[2mm]%
  \subcaptionbox{%
    $d = 1$%
  }[37mm]{%
    \includegraphics{financeEulerError_1}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 2$%
  }[37mm]{%
    \includegraphics{financeEulerError_2}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 3$%
  }[37mm]{%
    \includegraphics{financeEulerError_3}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 4$%
  }[37mm]{%
    \includegraphics{financeEulerError_4}%
  }%
  \caption[Convergence of the weighted Euler equation error]{%
    Convergence of the $\Ltwo$ norm $\weightedeulererrorLtwo_t$
    of the weighted Euler equation error for $t = 0$ for
    regular sparse grids \emph{\textcolor{C0}{(blue)}} and
    spatially adaptive sparse grids \emph{\textcolor{C1}{(red)}.}
    The number $\ngp_t$ is the mean number
    $\frac{1}{m_{\policy}} \sum_{j=1}^{m_{\policy}} \ngp_{t,j}$
    of grid points over all policy grids for $t = 0$,
    where $\ngp_{t,j}$ is the number of grid points
    of the $j$-th policy entry.%
  }%
  \label{fig:financeEulerError}%
\end{figure}%
For this and the following plots,
the value function grid is kept unchanged
(usually a slightly refined regular sparse grid),
while the mean number $\ngp_t$ of policy grid points increases
with decreasing refinement threshold $\refinetol_t$,
since the value function grid does not seem to have a great influence
on the convergence of the Euler equation errors.
The spatial adaptivity decreases the error by
two orders of magnitude in one dimension.
The gain is smaller for higher dimensionalities $d$,
but spatial adaptive grids still outperform regular grids.
For $d = 2$, we observe that the error saturates
after $\ngp_t \approx \num{4000}$ points before dropping below $10^{-5}$.
This is most likely due to the parts
\ref{item:financeErrorExtrapolation} to
\ref{item:financeErrorRounding} of the error that are not influenced
by sparse grid interpolation.
In addition, convergence significantly decelerates starting with $d = 4$.
For $d = 4$, spatially adaptive sparse grids with
a mean number $\ngp_t = \num{4252}$ of policy grid points for $t = 0$
are able to achieve a weighted Euler equation error of
$\weightedeulererrorLtwo_t \approx \num{2.0e-2}$.
For $d = 5$, we are still able to achieve an acceptable error of
$\weightedeulererrorLtwo_t \approx \num{3.2e-2}$
with spatially adaptive sparse grids with
a mean number $\ngp_t = \num{7768}$ of policy grid points for $t = 0$.
While we do not see any convergence for this dimensionality,
this is still a major result as such high-dimensional models
could not be solved with conventional methods up to now.

\paragraph{Optimal policies in 2D and 5D}

\Cref{fig:financeSolution2DSparseGrid,fig:financeSolution5DSparseGrid}
respectively display
\begin{figure}
  \subcaptionbox{%
    $\normcetvalueintp[1]_t$%
  }[48mm]{%
    \includegraphics{financeSolution2D_7}%
  }%
  \hfill%
  \subcaptionbox{%
    $\normbuy[\sparse,1]_{t,1}$%
  }[48mm]{%
    \includegraphics{financeSolution2D_8}%
  }%
  \hfill%
  \subcaptionbox{%
    $\normsell[\sparse,1]_{t,1}$%
  }[48mm]{%
    \includegraphics{financeSolution2D_10}%
  }%
  \\[2mm]%
  \subcaptionbox{%
    $\normbond_t^{\sparse,1}$%
  }[48mm]{%
    \includegraphics{financeSolution2D_12}%
  }%
  \hfill%
  \subcaptionbox{%
    $\normbuy[\sparse,1]_{t,2}$%
  }[48mm]{%
    \includegraphics{financeSolution2D_9}%
  }%
  \hfill%
  \subcaptionbox{%
    $\normsell[\sparse,1]_{t,2}$%
  }[48mm]{%
    \includegraphics{financeSolution2D_11}%
  }%
  \caption[Sparse grid solution for the two-dimensional TCP]{%
    Spatially adaptive sparse grid solution for the transaction costs problem
    with $d = 2$ stocks.
    \vspace{-0.15em}%
    Shown are the value function $\normcetvalueref_t$ \emph{(top left)} and the
    optimal policy $\optnormpolicyref_t$ for the initial time step $t = 0$,
    together with the corresponding grid points \emph{(dots).}
    The color coding is the same as in
    \cref{fig:financeSolution2DReference}.%
  }%
  \label{fig:financeSolution2DSparseGrid}%
\end{figure}%
\begin{figure}
  \makebox[37mm][c]{%
    \hspace*{3.8mm}%
    \raisebox{-\height}{\includegraphics{financeSolution5D_13}}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \hspace*{2.9mm}%
    \raisebox{-\height}{\includegraphics{financeSolution5D_14}}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \hspace*{4.7mm}%
    \raisebox{-\height}{\includegraphics{financeSolution5D_16}}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \hspace*{4.5mm}%
    \raisebox{-\height}{\includegraphics{financeSolution5D_15}}%
  }%
  \\[1mm]%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_1}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_4}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_12}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_9}%
  }%
  \\[1mm]%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_2}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_5}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_7}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_10}%
  }%
  \\[1mm]%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_3}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_6}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_8}%
  }%
  \hfill%
  \makebox[37mm][c]{%
    \includegraphics{financeSolution5D_11}%
  }%
  \caption[Sparse grid solution for the five-dimensional TCP]{%
    Spatially adaptive sparse grid solution for the transaction costs problem
    with $d = 5$ stocks.
    \vspace{-0.15em}%
    Shown are slice plots of
    the value function $\normcetvalueref_t$ \emph{(top left)} and
    the optimal policy $\optnormpolicyref_t$ for the initial time step $t = 0$,
    where for each function, a pair $(o_1, o_2)$
    of dimensions to be plotted was chosen,
    and the stock fractions $\stock_{t,o}$ of the other dimensions $o$
    are set to $0.1$.
    In addition, the corresponding grid points \emph{(dots)}
    are shown as the projection onto the
    $\stock_{t,o_1}$--$\stock_{t,o_2}$ plane.%
  }%
  \label{fig:financeSolution5DSparseGrid}%
\end{figure}%
the value function and optimal policies corresponding to
sparse grid solutions for
$d = 2$ stocks with $\ngp_0 = \num{879}$ policy grid points or
$d = 5$ stocks with $\ngp_0 = \num{7768}$ policy grid points.
Obviously, most grid points are placed along the various kinks in the
policies.
Interestingly, experiments show that the surplus-based refinement
criterion does not place more grid points along the perfect diagonal kink
caused by the cropping of the state space
(i.e., along $\sumfcn(\vstock_t) = 1$).
It is possible to circumvent this issue by either
transforming the domain (e.g., rotations as in \cite{Bohn18Optimally}) or
directly incorporating the distance to the diagonal into the
refinement criterion for the value function.
However, we refrain from doing so here as this does not seem to
drastically improve results.
This might be due to the domination of the overall error by
the parts \ref{item:financeErrorExtrapolation} to
\ref{item:financeErrorRounding} that are not related to interpolation.

\paragraph{Pointwise error}

Pointwise plots of the weighted Euler equation error,
as in \cref{fig:financePointwiseError} for two stocks,
reveal that there are two types of regions where the error is large:
The first region is the neighborhood of the aforementioned diagonal boundary
$\sumfcn(\vstock_t) = 1$ of the uncropped region,
where the cropping distorts the error despite the weights.
The second region are kinks of the optimal policy functions,
which is most visible for coarse grids
(e.g., \cref{fig:financePointwiseError_1}).
When increasing the number of grid points
(e.g., \cref{fig:financePointwiseError_1,fig:financePointwiseError_2}),
the error decreases quickly in the whole domain.

\begin{figure}
  \subcaptionbox{%
    $\ngp_t = 129$ (\num{5.3e-3})%
    \label{fig:financePointwiseError_1}%
  }[44mm]{%
    \clap{\includegraphics{financePointwiseError_1}}%
  }%
  \subcaptionbox{%
    $\ngp_t = 889$ (\num{2.1e-4})%
    \label{fig:financePointwiseError_2}%
  }[44mm]{%
    \clap{\includegraphics{financePointwiseError_2}}%
  }%
  \subcaptionbox{%
    $\ngp_t = 5159$ (\num{1.2e-5})%
    \label{fig:financePointwiseError_3}%
  }[44mm]{%
    \clap{\includegraphics{financePointwiseError_3}}%
  }%
  \hfill%
  \includegraphics{financePointwiseError_4}%
  \caption[Pointwise weighted Euler equation error for different grids]{%
    Pointwise weighted Euler equation error $\weightedeulererror_t(\vstock_t)$
    ($t = 0$) for the two-dimensional transaction costs problem and
    different spatially adaptive sparse grids.
    The $\Ltwo$ error $\weightedeulererrorLtwo_t$ is given in
    parentheses.%
  }%
  \label{fig:financePointwiseError}%
\end{figure}

\paragraph{Monte Carlo simulation}

As explained in \cref{sec:828postProecessing},
we perform a multi-individual Monte Carlo simulation
and plot the resulting mean state and policy in \cref{fig:financeSimulation}
for $d = 3$, $4$, and $5$ stocks.
\begin{figure}
  \includegraphics{financeSimulation_5}%
  \\[2mm]%
  \subcaptionbox{%
    $d = 3$%
    \label{fig:financeSimulation_1}%
  }[48mm]{%
    \includegraphics{financeSimulation_1}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 4$%
    \label{fig:financeSimulation_2}%
  }[48mm]{%
    \includegraphics{financeSimulation_2}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 5$%
    \label{fig:financeSimulation_3}%
  }[48mm]{%
    \includegraphics{financeSimulation_3}%
  }%
  %\\[2mm]%
  %\subcaptionbox{%
  %  $d = 3$ (stacked)%
  %}[38.5mm]{%
  %  \includegraphics{financeSimulation_4}%
  %}%
  %\hfill%
  %\begin{minipage}[b]{110.5mm}%
    \caption[Monte Carlo simulation of the transaction costs problem]{%
      Mean values of
      wealth $\wealth_t$
      \emph{\textcolor{C0}{(blue)},}
      unnormalized optimal bonds $\bond_t$
      \emph{\textcolor{C3}{(purple)},}
      unnormalized optimal consumption $\consume_t$
      \emph{\textcolor{C4}{(green)},} and
      unnormalized stock holdings
      $
        \acute{\vstock}_t
        := (\vstock_t + \vnormbuy_t - \vnormsell_t) \wealth_t
      $
      after buying and selling
      \emph{\textcolor{C1}{(red)}}
      in a Monte Carlo simulation of \num{10000} individuals,
      where we assume that $\wealth_0 = \$1$ for all individuals.
      In addition, the plots show the evolution of the
      $\Ltwo$ error $\weightedeulererrorLtwo_t$ over time $t$
      \emph{\textcolor{C7}{(pink, right axes)}.}%
    }%
    %\vspace*{-6.3mm}%
    \label{fig:financeSimulation}%
  %\end{minipage}%
\end{figure}%
In addition, this figure contains the evolution of the
weighted Euler equation error $\weightedeulererrorLtwo_t$ over time.
We perform a two-part assessment of the simulated results.
First, consumption should ideally be constant over time
from a finance perspective.
We measure this by calculating the coefficients of variation
(ratio of the standard deviation of the $c_t$ values to their mean),
which is \SI{2.8}{\percent}, \SI{2.7}{\percent}, and \SI{30}{\percent}
for $d = 3$, $4$, and $5$, respectively.
This indicates that while the three-stock and four-stock cases are
solved well, the five-stock case is not solved sufficiently accurately.
Second, we consider the so-called \term{Sharpe ratios}
\cite{Sharpe66Mutual}.
The ratios are stock fractions $\vstock$ that are determined
such that the excess stock return (compared to risk-free investment)
per risk is maximized:%
\footnote{%
  The Sharpe ratios per se are derived for non-skewed
  stock return rate distributions.
  Our stock return rates are log-normally distributed and thus skewed,
  but the deviation should be small after six time steps.
  However, there are variants that
  take skewed distributions into account \cite{Mueller15Ansaetze}.%
}
{%
  \setlength{\abovedisplayskip}{9pt}%
  \setlength{\belowdisplayskip}{9pt}%
  \begin{equation}
    \max_{\vstock \in \clint{0, 1}^d}
    \frac{
      \tr{\*\mu_{\range{1}{d}}} \vstock - \bondreturn
    }{
      \sqrt{\tr{\vstock} \mat{\Sigma}_{\range{1}{d},\range{1}{d}} \vstock}
    },
  \end{equation}%
}%
where $\*\mu_{\range{1}{d}}$ and
$\mat{\Sigma}_{\range{1}{d},\range{1}{d}}$
are the first $d$ entries of $\*\mu$ and
the principal minor of order $d$ of $\mat{\Sigma}$ as given in
\cref{eq:financeStockReturnMeanCovariance}.
We compare these theoretical Sharpe ratios (left)
with the simulated stock fractions
$\acute{\stock}_{t,o}/\sumfcn(\acute{\vstock}_t)$ for $t = 0$ (right):
\begin{subequations}
  \setlength{\jot}{0pt}%
  \setlength{\abovedisplayskip}{9pt}%
  \setlength{\belowdisplayskip}{9pt}%
  \begin{align}
    d = 3\colon\,&
    (0.314, 0.302, 0.384\rlap{),}\hphantom{, 0.999, 0.999}\quad
    (0.300, 0.317, 0.383),\\
    d = 4\colon\,&
    (0.275, 0.185, 0.250, 0.289\rlap{),}\hphantom{, 0.999}\quad
    (0.239, 0.238, 0.253, 0.270),\\
    d = 5\colon\,&
    (0.275, 0.122, 0.176, 0.203, 0.223\rlap{),}\quad
    (0.381, 0.000, 0.079, 0.195, 0.345).
  \end{align}
\end{subequations}
This unveils that the simulated stock fractions
match the predicted Sharpe ratios well for $d \le 4$,
while the stock fractions for $d = 5$ are visibly off.
As the five-dimensional simulated stock fractions
$(0.240, 0.151, 0.186, 0.205, 0.218)$
for $t = 4$ are still acceptable,
it seems that the computed policies lack accuracy for $t \le 3$,
a fact that is also supported by the growing
weighted Euler equation error (see \cref{fig:financeSimulation_3}).

% [0.2998, 0.3173, 0.3829]
% [0.2395, 0.2376, 0.2528, 0.2701]
% [0.3809, 0.0000, 0.0792, 0.1948, 0.3451] (t = 0)
% [0.2401, 0.1509, 0.1858, 0.2055, 0.2177] (t = 4)

% 0.3142    0.3020    0.3838
% 0.2755    0.1847    0.2503    0.2894
% 0.2749    0.1224    0.1765    0.2032    0.2229

% Die Idee ist der Sharpe-Ratio [1]:
% 
% max_x (x'*m-rf)./sqrt(x'*sig*x)
% wobei x Portfoliogewichte, m Mean der Rendite, sig Kovarianz der
% Rendite, rf risikolose Anlage
% 
% D.h., wähle die Portfoliogewichte so, dass Einheit Überrendite pro
% Einheit Risiko maximal ist
% 
% Üblicherweise kein Shortselling (also x in [0,1]^d für d Aktien und
% sum(x) = 1).
% 
% Kritik: Maß für Risiko ist hier nur die Standardabweichung der Rendite.
% Diese ist dankbar ungeeignet, wenn die Renditeverteilung schief ist.
% Wir nehmen lognormalverteilte Renditen an, d.h. die Verteilung ist
% bei uns schief.
% Es gibt Varianten, die die Schiefe berücksichtigen. Siehe Kapitel 3.4
% in [2].

%loadResult(22)
%problem.plotLifecycleProfile(simulation.state, simulation.discreteState, simulation.policy, simulation.shock)
%b = [0.0572, 0.0638, 0.07, 0.0764]
%A = [0.0256, 0.00576, 0.00288, 0.00176; ...
%0.00576, 0.0324, 0.0090432, 0.010692; ...
%0.00288, 0.0090432, 0.04, 0.0132; ...
%0.00176, 0.010692, 0.0132, 0.0484];
%rf = problem.Return.riskfreeRate
%f = @(x) -(x*b'-rf)./sqrt(x*A*x')
%xopt = fmincon(f, [1/4 1/4 1/4 1/4], [], [], [1 1 1 1], 1, [0 0 0 0], [1 1 1 1])

\paragraph{Complexity and runtime analysis}

% (e-mail 2018-01-03)
%Runtime of one optimize() run
%- -----------------------------
%O(#New state grid points
%* #Optimization iterations
%* #Quadrature points
%* #Old state grid points
%* #State dimensions
%* Runtime of one 1D basis evaluation)
%
%where
%#(Optimization iterations) depends on #(Policy dimensions),
%#(Policy dimensions) = 2 * #Stocks + 1
%#(State dimensions) = #Stocks + 1
%
%(modulo extrapolations)

The fact that the difficulty of the problem grows very fast with $d$
can be explained with a complexity analysis:
The number of necessary arithmetic operations grows like
(cf.\ \cref{fig:structureSolveValueFunction})
{%
  \setlength{\abovedisplayskip}{6pt}%
  \setlength{\belowdisplayskip}{6pt}%
  \begin{equation}
    \landauTheta{
      % for every time step
      T
      % for every grid point of new time step
      \cdot \ngp_t
      % for every optimization iteration
      \cdot \text{\#optimizer iterations}
      \cdot
      \underbrace{
        % for every gradient entry of the objective function
        m_{\policy}
        % for every quadrature point
        \cdot m_{\zeta}
        \cdot
        \overbrace{
          % for every summand of the sparse grid function
          % (grid point of old time step)
          \ngp_{t+1}
          % for every tensor product factor
          \cdot m_{\state}
          % for every B-spline summand
          \cdot p
        }^{\mathclap{\text{one evaluation of interpolant}}}
      }_{\mathclap{\text{one evaluation of objective gradient}}}\,
    },
  \end{equation}%
}%
where $m_{\state}, m_{\policy} \in \landauTheta{d}$,
$m_{\zeta}, \ngp_t, \ngp_{t+1} \in \landauTheta{2^n n^{d-1}}$
if regular sparse grids of level $n$
without boundary points would be used for state and stochastic grids
(due to $m_{\stochastic} = d$), and
the number of optimizer iterations is likely superlinear in $d$,
as this depends on the dimensionality $m_{\policy}$ of the search space
as well as on the number of multi-start points
(which also grows with $m_{\policy}$).
This means that the complexity is at least cubic in $d$,
quadratic in the mean number $\ngp$ of employed state grid points, and
linear in the number $m_{\zeta}$ of quadrature points.

\begin{figure}
  \includegraphics{financeRuntime_7}%
  \\[1mm]%
  \subcaptionbox{%
    $d = 1$%
  }[48mm]{%
    \includegraphics{financeRuntime_1}%
    \newline\hspace*{1.764mm}%
    \includegraphics{financeRuntime_2}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 2$%
  }[48mm]{%
    \includegraphics{financeRuntime_3}%
    \newline\hspace*{1.764mm}%
    \includegraphics{financeRuntime_4}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 3$%
  }[48mm]{%
    \includegraphics{financeRuntime_5}%
    \newline\hspace*{1.764mm}%
    \includegraphics{financeRuntime_6}%
  }%
  \caption[Computation times and numbers of iterations for the TCP]{%
    Computation times \emph{(top)} and
    numbers of iterations and interpolant evaluations \emph{(bottom)}
    for the transaction costs problem on static regular sparse grids
    (i.e., without refinement).
    ``Total time'' is the serial time required to solve all $T\ngp$
    emerging optimization problems.
    ``Time per opt.''\ is the total time divided by the number $T\ngp$
    of optimization problems.
    The colors correspond to B-spline degrees $p = 3$ or $p = 1$ and
    to using gradients ($\nabla$) or finite differences (FD).%
  }%
  \label{fig:financeRuntime}%
\end{figure}%

\dummytext[1]{}

\paragraph{Comparison to piecewise linear functions}

% certainty-equivalent consumption (aus Simulation?)
% mit B-splines und linearen Funktionen

\dummytext[1]{}

\paragraph{Comparing exact gradients to finite differences}

\dummytext[1]{}
