% ======================================================================
% Meta-Data
% ======================================================================

% meta-data variables
\newcommand*{\thetitle}{%
  B-Splines for Sparse Grids:\texorpdfstring{\\}{}
  Algorithms and Application to\texorpdfstring{\\}{}
  Higher-Dimensional Optimization%
}
\newcommand*{\theauthor}{Julian Valentin}
\newcommand*{\thebirthplace}{Stuttgart}
\newcommand*{\thedefensedate}{\todo{insert date of defense}}
\newcommand*{\thedate}{\todo{insert date}}
\newcommand*{\theyear}{2018}
\newcommand*{\theinstitute}{Institut für Parallele und Verteilte Systeme}
\newcommand*{\theadvisor}{Prof.\ Dr.\ Dirk Pflüger}
\newcommand*{\theexamineri}{Univ.-Prof.\ Oliver Röhrle, PhD}
\newcommand*{\theexaminerii}{\todo{insert 2nd examiner}}
\newcommand*{\theexamineriii}{\todo{insert 3rd examiner}}

% ======================================================================
% KOMA-Script and Text Area
% ======================================================================

% options for KOMA-Script
\KOMAoptions{
  % choose font size (PO: should be between 12pt and 14pt)
  fontsize=12pt,
  % suppress "very small head height detected" warning
  DIV=12,
  % don't end section numbers with period despite appendices
  numbers=noendperiod,
  % set linespacing of header and footer to 1.5
  % (otherwise, the header will "jump" back and forth from normal
  % pages and pages with single line spacing, e.g., table of contents)
  onpsinit=\onehalfspacing,
}

% binding offset that will be substracted from inner margins
\newcommand*{\bindingoffset}{10mm}

% set page margins
\geometry{
  bindingoffset=\bindingoffset,
  inner=15mm,
  outer=30mm,
  top=20mm,
  bottom=30mm,
  includehead=true,
}

% ======================================================================
% Table of Contents
% ======================================================================

% use single spacing in table of contents
\AfterTOCHead[toc]{\singlespacing}

% include subsubsections in table of contents, but without numbers
\setcounter{tocdepth}{\subsubsectionnumdepth}

% ======================================================================
% Headings
% ======================================================================

% don't use sans-serif font for headings
\setkomafont{disposition}{\normalcolor\bfseries}

% chapter heading: make number bigger
\renewcommand*{\chapterformat}{%
  \mbox{%
    \chapappifchapterprefix{\nobreakspace}%
    \scalebox{3.2}{\thechapter\autodot}%
    \IfUsePrefixLine{}{\enskip}%
  }%
}

% chapter heading: align number and text at the baseline of the last line
% of the text, add some more space between number and text
\renewcommand*{\chapterlinesformat}[3]{%
  \begin{tabularx}{\textwidth}{@{}l@{}X@{}}%
    % chapter number
    #2%
    % add hspace between number and text, but only if \chapter (not \chapter*)
    % has been used (i.e., if the chapter number #2 is not empty)
    \if\relax\detokenize{#2}\relax\else\hspace*{5mm}\fi&%
    % text of heading, [b] is for alignment, \linewidth is width of X cell,
    % \raggedchapter for not justifying headings
    \parbox[b]{\linewidth}{\raggedchapter\singlespacing#3}%
  \end{tabularx}%
}

% decrease skip before \paragraph and \subparagraph headings
\RedeclareSectionCommand[beforeskip=2ex plus 1ex minus .2px]{paragraph}
\RedeclareSectionCommand[beforeskip=1ex plus 1ex minus .2px]{subparagraph}

\makeatletter

% append period to \paragraph headings
\let\paragraphwithoutperiod\paragraph
\newcommand*{\paragraphwithperiodwithstar}[1]{\paragraphwithoutperiod*{#1.}}
\newcommand*{\paragraphwithperiod}[1]{\paragraphwithoutperiod{#1.}}
\renewcommand*{\paragraph}{%
  \@ifstar{\paragraphwithperiodwithstar}{\paragraphwithperiod}%
}

% append period to \subparagraph headings
\let\subparagraphwithoutperiod\subparagraph
\newcommand*{\subparagraphwithperiodwithstar}[1]{\subparagraphwithoutperiod*{#1.}}
\newcommand*{\subparagraphwithperiod}[1]{\subparagraphwithoutperiod{#1.}}
\renewcommand*{\subparagraph}{%
\@ifstar{\subparagraphwithperiodwithstar}{\subparagraphwithperiod}%
}

\makeatother

% increase indentation of paragraphs (default: 1em = \quad)
\setlength{\parindent}{2em}

% ======================================================================
% Dictums
% ======================================================================

% don't use sans-serif font for dictums
\addtokomafont{dictum}{\rmfamily}

% format dictums with custom command
\renewcommand*{\dictum}[2][]{\cleanchapterquote{#2}{#1}}

% shortcut for setting the dictum for a chapter
\newcommand*{\setdictum}[2]{%
  \setchapterpreamble{%
    \dictum[#2]{#1}%
    \chapterheadendvskip%
  }%
}

% fancy quotes (taken from cleanthesis.sty, slightly adapted)
\newcommand*{\hugequote}{%
  \fontsize{75}{80}\selectfont%
  \hspace*{-0.6em}\color{lightgray}%
  \textit{``}%
  \vskip -0.8em%
}

\newcommand*{\cleanchapterquote}[2]{%
  \begin{minipage}{\textwidth}%
    \begin{flushright}
      \begin{minipage}{0.54\textwidth}%
        \begin{flushleft}
          {\hugequote}\textit{#1}
        \end{flushleft}
        \begin{flushright}
          \small--- #2
        \end{flushright}
      \end{minipage}%
    \end{flushright}
  \end{minipage}%
  \bigskip
}

% ======================================================================
% Page Headers and Footers
% ======================================================================

% all-caps sans-serif page header
\setkomafont{pageheadfoot}{%
  \normalfont\normalcolor\sffamily%
  \fontsize{9.5}{12}\selectfont\lsstyle%
}
\setkomafont{pagenumber}{\usekomafont{pageheadfoot}\bfseries}

% move page number to page header
\clearscrheadfoot
\lehead[\pagemark]{\pagemark}
\rehead[]{\headmark}
\lohead[]{\headmark}
\rohead[\pagemark]{\pagemark}
\lefoot[]{}
\rofoot[]{}

% prepend "Chapter X: " in front of the chapter name in page headers
\renewcommand*{\chaptermarkformat}{Chapter \thechapter: }

% ======================================================================
% Float Captions
% ======================================================================

% change font size for captions
\makeatletter
\DeclareCaptionFormat{mycaptionformat}{%
  \small\@hangfrom{#1#2}%
  \advance\caption@parindent\hangindent
  \advance\caption@hangindent\hangindent
  \caption@@par#3\par%
}
\makeatother

% change appearance of caption label
\DeclareCaptionLabelFormat{mycaptionlabelformat}{%
  \sffamily\bfseries\fontsize{9.5}{12}\selectfont\textls*{\MakeUppercase{#1}} #2%
}

% set caption format
\captionsetup{
  % use custom format
  format=mycaptionformat,
  % use custom label format
  labelformat=mycaptionlabelformat,
  % separate number and caption with \quad
  labelsep=quad,
}

% change font size for sub-captions
\makeatletter
\DeclareCaptionFormat{mysubcaptionformat}{%
  \fontsize{10}{12}\selectfont\@hangfrom{#1#2}%
  \advance\caption@parindent\hangindent
  \advance\caption@hangindent\hangindent
  \caption@@par#3\par%
}
\makeatother

% change appearance of sub-caption label
\DeclareCaptionLabelFormat{mysubcaptionlabelformat}{%
  \sffamily\bfseries\fontsize{8.8}{11}\selectfont\textls*{\MakeUppercase{#2}}%
}

% set sub-caption format
\captionsetup[sub]{
  % use custom format
  format=mysubcaptionformat,
  % use custom label format
  labelformat=mysubcaptionlabelformat,
  % separate number and caption with \quad
  labelsep=quad,
}

% ======================================================================
% Algorithms
% ======================================================================

% line number format
\algrenewcommand{\alglinenumber}[1]{\footnotesize\color{anthrazit}{\texttt{#1}}}
\algrenewcommand{\algorithmicrequire}{\textbf{Input:}}
\algrenewcommand{\algorithmicensure}{\textbf{Output:}}

% keywords (bold and typewriter)
\algnewcommand{\Break}{\texttt{\textbf{break}}}
\algnewcommand{\Continue}{\texttt{\textbf{continue}}}
\algnewcommand{\True}{\texttt{\textbf{true}}}
\algnewcommand{\False}{\texttt{\textbf{false}}}
\algnewcommand{\Null}{\texttt{\textbf{null}}}
\algrenewcommand{\algorithmicend}{\texttt{\textbf{end}}}
\algrenewcommand{\algorithmicdo}{\texttt{\textbf{do}}}
\algrenewcommand{\algorithmicwhile}{\texttt{\textbf{while}}}
\algrenewcommand{\algorithmicfor}{\texttt{\textbf{for}}}
\algrenewcommand{\algorithmicforall}{\texttt{\textbf{for all}}}
\algrenewcommand{\algorithmicloop}{\texttt{\textbf{loop}}}
\algrenewcommand{\algorithmicrepeat}{\texttt{\textbf{repeat}}}
\algrenewcommand{\algorithmicuntil}{\texttt{\textbf{until}}}
\algrenewcommand{\algorithmicprocedure}{\texttt{\textbf{procedure}}}
\algrenewcommand{\algorithmicfunction}{\texttt{\textbf{function}}}
\algrenewcommand{\algorithmicif}{\texttt{\textbf{if}}}
\algrenewcommand{\algorithmicthen}{\texttt{\textbf{then}}}
\algrenewcommand{\algorithmicelse}{\texttt{\textbf{else}}}
\algrenewcommand{\algorithmicreturn}{\texttt{\textbf{return}}}
\algnewcommand{\algorithmicforever}{\texttt{\textbf{for ever}}}
\algdef{S}[FOR]{ForEver}{\algorithmicforever\ \algorithmicdo}
\algnewcommand{\algorithmicgoto}{\texttt{\textbf{go to}}}%
\algnewcommand{\Goto}[1]{\algorithmicgoto\ line\ \ref*{#1}}%

% font size in algorithms
\makeatletter
\renewcommand*{\ALG@beginalgorithmic}{\small}
\makeatother

% comment format
\algrenewcomment[1]{\hfill$\rightsquigarrow$ \emph{#1}}

% declare algorithm float environment
\DeclareNewTOC[
  type=algorithm,
  name=Algorithm,
  float,
  floattype=4,
  counterwithin=chapter,
]{loa}

% ======================================================================
% Floats
% ======================================================================

% automatically center all float and subfigure contents
\makeatletter
\g@addto@macro{\@floatboxreset}{\centering}
\apptocmd\subcaption@minipage{\centering}{}{}
\makeatother

% change font size in float environments
\makeatletter
\g@addto@macro{\figure}{\small}
\g@addto@macro{\table}{\small}
\g@addto@macro{\algorithm}{\small}
\makeatother

% ======================================================================
% Theorems
% ======================================================================

% define mdframed style for theorems (left bar)
\mdfdefinestyle{mymdfstyle}{
  hidealllines=true,
  leftline=true,
  innerleftmargin=10pt,
  innerrightmargin=0pt,
  innertopmargin=-1pt,
  innerbottommargin=0pt,
  linewidth=2pt,
  linecolor=anthrazit,
}

% define theorem styles (format theorem "head" with sans-serif caps)
\declaretheoremstyle[
  headfont={\sffamily\bfseries\fontsize{9.5}{12}\selectfont},
  headformat={\textls*{\MakeUppercase{\NAME{} \NUMBER}}\hspace{0.7em}\NOTE\\},
  notefont={\normalfont\normalsize},
  headpunct={},
]{mythmdefstyle}

% same as before, but italic body font
\declaretheoremstyle[
  headfont={\sffamily\bfseries\fontsize{9.5}{12}\selectfont},
  headformat={\textls*{\MakeUppercase{\NAME{} \NUMBER}}\hspace{0.7em}\NOTE\\},
  notefont={\normalfont\normalsize},
  headpunct={},
  bodyfont={\itshape},
]{mythmplainstyle}

% same as before, but no note and line break after head
\declaretheoremstyle[
  headfont={\sffamily\bfseries\fontsize{9.5}{12}\selectfont},
  headformat={\textls*{\MakeUppercase{\NAME{} \NUMBER}}\hspace{0.7em}},
  notefont={\normalfont\normalsize},
  headpunct={},
  bodyfont={\itshape},
]{mythmshortplainstyle}

% proofs are set like normal text
\declaretheoremstyle[
  headfont={\normalfont\normalsize\itshape},
  headpunct={.},
  qed={\qedsymbol},
]{mythmproofstyle}

% redefine proof environment as the vertical spacing of the default
% environment seems to be a bit weird (it's implemented as a list...)
\let\proof\relax
\let\endproof\relax

% theorem environments
\declaretheorem[
  name={Definition},
  numberwithin=chapter,
  mdframed={style=mymdfstyle},
  style=mythmdefstyle,
]{definition}
\declaretheorem[
  name={Theorem},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{theorem}
\declaretheorem[
  name={Proposition},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{proposition}
\declaretheorem[
  name={Lemma},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{lemma}
\declaretheorem[
  name={Corollary},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{corollary}
\declaretheorem[
  name={Corollary},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmshortplainstyle,
]{shortcorollary}
\declaretheorem[
  name={Proof},
  unnumbered,
  style=mythmproofstyle,
]{proof}

% ======================================================================
% Mathematics
% ======================================================================

% vertically center ":" in ":="
\mathtoolsset{centercolon}

% automatically replace "l" with \ell in math mode
\mathcode`l="8000
\begingroup
\makeatletter
\lccode`\~=`\l
\DeclareMathSymbol{\lsb@l}{\mathalpha}{letters}{`l}
\lowercase{\gdef~{\ifnum\the\mathgroup=\m@ne \ell \else \lsb@l \fi}}%
\endgroup

% ======================================================================
% Blindtext
% ======================================================================

% get name of current label (chapter, section, subsection, ...)
\makeatletter
\newcommand*{\currentname}{\@currentlabelname}
\makeatother

% warn for every usage of \blindtext
\let\oldblindtext\blindtext
\renewcommand*{\blindtext}{%
  \GenericWarning{}{%
    LaTeX Warning (\thesubsection\space\currentname): \string\blindtext%
  }%
  \oldblindtext%
}

% ======================================================================
% Graphics
% ======================================================================

% location of graphics files
\graphicspath{{../gfx/}}

% ======================================================================
% Dynamic Commands
% ======================================================================

% calculate difference between page numbers
\newcommand*{\pagedifference}[2]{%
  \number\numexpr\getpagerefnumber{#2}-\getpagerefnumber{#1}\relax%
}

% custom TODO command with warning
% (all packages that were tried produced problems)
\newcommand*{\todo}[1]{%
  \GenericWarning{}{%
    LaTeX Warning (\thesubsection\space\currentname): TODO "#1"%
  }%
  \textcolor{red}{TODO: #1}%
}

% set up versioning information
\luaexec{require("version")}
\edef\gitCommitHash{\luadirect{getGitCommitHash()}}
\edef\gitCommitTimeShort{\luadirect{getGitCommitTimeShort()}}
\edef\gitCommitTimeLong{\luadirect{getGitCommitTimeLong()}}
\edef\currentTimeShort{\luadirect{getCurrentTimeShort()}}
\edef\currentTimeLong{\luadirect{getCurrentTimeLong()}}
\edef\getAndIncreaseCompileCounter{\luadirect{getAndIncreaseCompileCounter()}}

% ======================================================================
% Colors
% ======================================================================

% define line colors (mix between MATLAB and matplotlib colors)
\definecolor{C0}{rgb}{0.000,0.447,0.741}
\definecolor{C1}{rgb}{0.850,0.325,0.098}
\definecolor{C2}{rgb}{0.929,0.694,0.125}
\definecolor{C3}{rgb}{0.494,0.184,0.556}
\definecolor{C4}{rgb}{0.466,0.674,0.188}
\definecolor{C5}{rgb}{0.301,0.745,0.933}
\definecolor{C6}{rgb}{0.635,0.078,0.184}
\definecolor{C7}{rgb}{0.887,0.465,0.758}
\definecolor{C8}{rgb}{0.496,0.496,0.496}

% define university CD colors
\definecolor{anthrazit}{RGB}{62,68,76}
\definecolor{mittelblau}{RGB}{0,81,158}
\definecolor{helllblau}{RGB}{0,190,255}

% ======================================================================
% Blindtext
% ======================================================================

% check mode
\iftoggle{checkMode}{
  % show overfull boxes
  \overfullrule=1mm
  % whitelist is in hyphenation_whitelist.txt:
  % one word per line (all lowercase) with dashes (-) indicating the
  % places where hyphenation is permitted
  \LuaCheckHyphen{whitelist=hyphenation_whitelist.txt}
}{}

% ======================================================================
% Flip Book
% ======================================================================

% set up flip book
\iftoggle{flipBookMode}{
  \newcounter{currentpagenumber}
  \iftoggle{partialCompileMode}{}{
    % start flip book after second title page
    \setcounter{currentpagenumber}{-4}
  }
  \newcount\flipbookindex
  
  \AddEverypageHook{%
    \stepcounter{currentpagenumber}%
    \flipbookindex=\numexpr\thecurrentpagenumber/2\relax%
    \ifnum\number\flipbookindex>0%
      \begin{tikzpicture}[remember picture,overlay,scale=1]
        \ifthispageodd{
          \node[anchor=south east,inner sep=0pt,xshift=4mm,yshift=2mm]
          at (current page.south east) [above left] {%
            \includegraphics{flipBookBSpline_\number\flipbookindex}%
          };
        }{
          \node[anchor=south west,inner sep=0pt,xshift=0mm,yshift=-3mm]
          at (current page.south west) [above right] {%
            \includegraphics[scale=0.8]{flipBookSG_\number\flipbookindex}%
          };
        }
      \end{tikzpicture}%
    \fi%
  }
}{}

% ======================================================================
% Watermarks
% ======================================================================

% set up watermarks
\iftoggle{draftMode}{
  \AddEverypageHook{%
    \begin{tikzpicture}[remember picture,overlay,scale=1]
      \node[
        opacity=0.5,anchor=center,xshift=0mm,yshift=7mm,inner sep=0pt,
      ] at (current page.south) [above] {
        \parbox{100mm}{%
          \begin{center}%
            \onehalfspacing\bfseries\color{black}%
            Draft v\getAndIncreaseCompileCounter{} (\currentTimeShort)\\%
            Commit \gitCommitHash{} (\gitCommitTimeShort)%
          \end{center}%
        }%
      };
      \ifthispageodd{
        \node[
          opacity=0.5,anchor=north east,xshift=-15mm,yshift=-38.5mm,
          inner sep=0pt,text width=4.51mm,align=right,
        ] at (current page.north east) [below left] {%
          \ttfamily\onehalfspacing%
          1\\2\\3\\4\\5\\6\\7\\8\\9\\10\\%
          11\\12\\13\\14\\15\\16\\17\\18\\19\\20\\%
          21\\22\\23\\24\\25\\26\\27\\28\\29\\30\\%
          31\\32\\33\\34\\35\\36\\37\\%
        };
      }{
        \node[
          opacity=0.5,anchor=north west,xshift=15mm,yshift=-38.5mm,color=black,
          inner sep=0pt,text width=4.51mm,align=right,
        ] at (current page.north west) [below right] {%
          \ttfamily\onehalfspacing%
          1\\2\\3\\4\\5\\6\\7\\8\\9\\10\\%
          11\\12\\13\\14\\15\\16\\17\\18\\19\\20\\%
          21\\22\\23\\24\\25\\26\\27\\28\\29\\30\\%
          31\\32\\33\\34\\35\\36\\37\\%
        };
      }
    \end{tikzpicture}%
  }
}{}

% ======================================================================
% PDF Meta-Data and Links
% ======================================================================

% set up hyperref
\hypersetup{
  % set metadata
  pdftitle={\thetitle},
  pdfauthor={\theauthor},
  pdfcreator={LaTeX, KOMA-Script, hyperref},
  % underline links instead of putting a framed box around them
  pdfborderstyle={/S/U/W 1},
  % set link colors
  citebordercolor=C1,
  filebordercolor=C1,
  linkbordercolor=C1,
  menubordercolor=C1,
  runbordercolor=C1,
  urlbordercolor=C0,
}

% include parentheses of \eqref in hyperlink
\makeatletter
\renewcommand*{\eqref}[1]{\hyperref[{#1}]{\textup{\tagform@{\ref*{#1}}}}}
\makeatother

% ======================================================================
% Bibliography
% ======================================================================

% break URLs after every character (most importantly for bibliography)
\luaexec{require("breakurl")}
\let\oldhref\href
\renewcommand*{\url}[1]{\luadirect{breakurl(\luastringN{#1}, \luastringN{#1})}}
\renewcommand*{\href}[2]{\luadirect{breakurl(\luastringN{#1}, \luastringN{#2})}}

\iftoggle{partialCompileMode}{
  \renewcommand*{\cite}[1]{#1}
}{
  % location of *.bib file
  \addbibresource{../bib/bibliography.bib}
  
  % don't append "+" sign to BibLaTeX citations in alphabetic style
  \renewcommand*{\labelalphaothers}{}
  
  % insert colon after author names in bibliography
  \renewcommand*{\labelnamepunct}{: }
  
  % hide urldate field
  \AtEveryBibitem{\clearfield{urlyear}}
  
  % make paper titles italic, remove quotation marks
  \DeclareFieldFormat[article]{title}{\mkbibemph{#1}}
  \DeclareFieldFormat[article]{journaltitle}{#1}
  \DeclareFieldFormat[thesis]{title}{\mkbibemph{#1}}
  \DeclareFieldFormat[inbook]{title}{\mkbibemph{#1}}
  \DeclareFieldFormat[inbook]{booktitle}{#1}
  \DeclareFieldFormat[incollection]{title}{\mkbibemph{#1}}
  \DeclareFieldFormat[incollection]{booktitle}{#1}
  \DeclareFieldFormat[inproceedings]{title}{\mkbibemph{#1}}
  \DeclareFieldFormat[inproceedings]{booktitle}{#1}
  \DeclareFieldFormat[unpublished]{title}{\mkbibemph{#1}}
  
  % fix title capitalization to sentence case (all lowercase)
  \DeclareFieldFormat{titlecase}{\MakeSentenceCase*{#1}}
  
  % ... but don't change journal titles
  \renewbibmacro*{journal}{%
    \iffieldundef{journaltitle}{}{%
      \printtext[journaltitle]{%
        \printfield[noformat]{journaltitle}%
        \setunit{\subtitlepunct}%
        \printfield[noformat]{journalsubtitle}%
      }%
    }%
  }
  
  % suppress "In:" before journal names
  \renewbibmacro*{in:}{}
  
  % separate authors with semicolon, suppress "and" in author names
  \renewcommand{\multinamedelim}{\addsemicolon\space}
  \renewcommand*{\finalnamedelim}{\addsemicolon\space}
  
  % make names bold
  \renewcommand*{\mkbibnamefamily}[1]{\textbf{#1}}
  
  \DeclareNameAlias{sortname}{last-first}
  \DeclareNameAlias{default}{last-first}
  
  % define custom heading to fix non-uppercase page header, make URLs smaller
  \defbibheading{myheading}[\bibname]{%
    \addchap{#1}%
    \markboth{BIBLIOGRAPHY}{BIBLIOGRAPHY}%
    \let\oldtexttt\texttt%
    \renewcommand*{\texttt}[1]{\oldtexttt{\scriptsize##1}}%
  }
  
  % add custom bibliography post note (URLs last checked on ...)
  \defbibnote{mypostnote}{%
    All URLs have last been checked on \thedate.%
    \renewcommand*{\texttt}[1]{\oldtexttt{##1}}%
  }
  
  % omit "URL:" and "DOI:" separators to save space
  \DeclareFieldFormat{url}{\url{#1}}
  \DeclareFieldFormat{doi}{%
    \ifhyperref{\href{https://doi.org/#1}{\nolinkurl{#1}}}{\nolinkurl{#1}}%
  }
  
  % change font size of bibliography
  \renewcommand*{\bibfont}{\small}
  
  % set single line spacing for bibliography
  \renewcommand*{\bibsetup}{\singlespacing}
}

% ======================================================================
% Glossary
% ======================================================================

\makeatletter

\iftoggle{partialCompileMode}{
  \newcommand*{\newgsymbol}[3]{}
  \newcommand*{\newgacronym}[3]{\newnamecommand{#1}{#2\xspace}}
}{
  % define new glossary style based on long (uses longtable)
  % in which the column widths are fixed and space before/after the
  % table is removed
  \newglossarystyle{long3fixed}{%
    \setglossarystyle{long3col}%
    \renewenvironment{theglossary}%
    {%
      \setlength{\LTpre}{0pt}%
      \setlength{\LTpost}{0pt}%
      \begin{spacing}{1}%
        \begin{longtable}{%
            @{}p{0.15\textwidth}@{}%
            p{0.78\textwidth}@{}%
            >{\raggedleft}p{0.07\textwidth}@{}%
        }%
          \textbf{Symbol}&\textbf{Meaning}&\textbf{Page}\vspace{2mm}\endhead%
    }%
    {%
        \end{longtable}%
      \end{spacing}%
    }%
    \renewcommand*{\glossentry}[2]{%
      \glsentryitem{##1}\glstarget{##1}{\glossentryname{##1}}&%
      \glossentrydesc{##1}\leavevmode\kern3pt\leaders\hbox{.}\hfill\kern0pt&%
      ##2\tabularnewline%
    }%
  }
  
  % use new glossary style
  \setglossarystyle{long3fixed}
  
  % disable output of \gls, insert text manually
  % (the glossaries package has no command to just reference an entry
  % without inserting something...)
  \renewcommand*{\glstextformat}[1]{}
  
  % shortcut for \newglossaryentry + \gls
  \newcommand*{\newgsymbol}[3]{%
    \newglossaryentry{#1}{sort=#1,name={#2},description={#3}}%
    % only reference the entry if not in preamble
    \ifx\@onlypreamble\@notprerr\gls{#1}\fi%
  }
  
  % shortcut for \newacronym, automatically generating
  % a corresponding command that references the entry
  \newcommand*{\newgacronym}[3]{%
    \newacronym[sort=#1]{#1}{#2}{#3}%
    \newnamecommand{#1}{\gls{#1}#2\xspace}%
  }
  
  % generate table of symbols and acronyms
  \makeglossaries
}

% add debug info about definitions of glossary entries
\iftoggle{showGlossaryDefinitionsMode}{
  \let\oldnewgsymbol\newgsymbol
  \renewcommand*{\newgsymbol}[3]{%
    \ifx\@onlypreamble\@notprerr%
      \textcolor{C1}{Defining ``#2'' as ``#3''. }%
    \fi%
    \oldnewgsymbol{#1}{#2}{#3}%
  }
}{}

\makeatother
