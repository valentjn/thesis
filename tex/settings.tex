% ======================================================================
% Meta-Data
% ======================================================================

% meta-data variables
\newcommand*{\thetitle}{%
  B-Splines for Sparse Grids:\texorpdfstring{\\}{}
  Algorithms and Application to\texorpdfstring{\\}{}
  Higher-Dimensional Optimization%
}
\newcommand*{\theauthor}{Julian Valentin}
\newcommand*{\thebirthplace}{Stuttgart}
\newcommand*{\thedefensedate}{\todo{insert date of defense}}
\newcommand*{\thedate}{\todo{insert date}}
\newcommand*{\theyear}{2018}
\newcommand*{\theinstitute}{Institut für Parallele und Verteilte Systeme}
\newcommand*{\theadvisor}{Prof.\ Dr.\ Dirk Pflüger}
\newcommand*{\theexamineri}{Univ.-Prof.\ Oliver Röhrle, PhD}
\newcommand*{\theexaminerii}{\todo{insert 2nd examiner}}
\newcommand*{\theexamineriii}{\todo{insert 3rd examiner}}

% ======================================================================
% KOMA-Script and Text Area
% ======================================================================

% options for KOMA-Script
\KOMAoptions{
  % choose font size (PO: should be between 12pt and 14pt)
  fontsize=12pt,
  % suppress "very small head height detected" warning
  DIV=12,
  % don't end section numbers with period despite appendices
  numbers=noendperiod,
  % set linespacing of header and footer to 1.5
  % (otherwise, the header will "jump" back and forth from normal
  % pages and pages with single line spacing, e.g., table of contents)
  onpsinit=\onehalfspacing,
}

% binding offset that will be substracted from inner margins
\newcommand*{\bindingoffset}{10mm}

% set page margins
\geometry{
  bindingoffset=\bindingoffset,
  inner=15mm,
  outer=30mm,
  top=20mm,
  bottom=30mm,
  includehead=true,
}

% ======================================================================
% Graphics
% ======================================================================

% location of graphics files
\graphicspath{{../gfx/}}

% TikZ libraries
\usetikzlibrary{
  % curly braces
  decorations.pathreplacing,
  % ornamental lines
  patterns.images,
}

% ======================================================================
% Cross-References
% ======================================================================

% define abbreviated names for cross-references
\crefname{algorithm}{Alg.}{Algorithms}
\Crefname{algorithm}{Algorithm}{Algorithms}

\crefname{chapter}{Chap.}{Chapters}
\Crefname{chapter}{Chapter}{Chapters}

\crefname{corollary}{Cor.}{Corollaries}
\Crefname{corollary}{Corollary}{Corollaries}

\crefname{definition}{Def.}{Definitions}
\Crefname{definition}{Definition}{Definitions}

\crefname{equation}{Eq.}{Equations}
\Crefname{equation}{Equation}{Equations}

\crefname{figure}{Fig.}{Figures}
\Crefname{figure}{Figure}{Figures}

\crefname{lemma}{Lemma}{Lemmas}
\Crefname{lemma}{Lemma}{Lemmas}

\crefname{line}{Line}{Lines}
\Crefname{line}{Line}{Lines}

\crefname{proposition}{Prop.}{Propositions}
\Crefname{proposition}{Proposition}{Propositions}

\crefname{section}{Sec.}{Sections}
\Crefname{section}{Section}{Sections}

\crefname{table}{Tab.}{Tables}
\Crefname{table}{Table}{Tables}

\crefname{theorem}{Thm.}{Theorems}
\Crefname{theorem}{Theorem}{Theorems}

% reference theorems with their name appended
\newcommand*{\thmref}[1]{\hyperlink{#1}{\cref*{#1}~(\nameref*{#1})}}
\newcommand*{\Thmref}[1]{\hyperlink{#1}{\Cref*{#1}~(\nameref*{#1})}}

% ======================================================================
% Table of Contents
% ======================================================================

% use single spacing in table of contents
\AfterTOCHead[toc]{\singlespacing}

% include subsubsections in table of contents, but without numbers
\setcounter{tocdepth}{\subsubsectionnumdepth}

% ======================================================================
% Headings
% ======================================================================

% don't use sans-serif font for headings, use single spacing
\setkomafont{disposition}{\normalcolor\bfseries\setstretch{1}}

% format chapter headings with custom commands (below)
\renewcommand*{\chapterformat}{\chapternumber{\thechapter\autodot}}
\renewcommand*{\chapterlinesformat}[3]{#2\chaptertitle{#3}}

% scale chapter number, bottom alignment
\newcommand*{\chapternumber}[1]{%
  \begin{minipage}[b]{0.15\linewidth}%
    \chapappifchapterprefix{\nobreakspace}%
    \scalebox{3.2}{#1\vphantom{0123456789}}%
    \IfUsePrefixLine{}{\enskip}%
  \end{minipage}%
}

% left-align chapter title
\newcommand*{\chaptertitle}[1]{%
  \leavevmode\smash{%
    \begin{minipage}[b]{0.85\linewidth}%
      \raggedchapter#1%
    \end{minipage}%
  }%
}

% set space before and after chapter heading
\RedeclareSectionCommand[beforeskip=8em,afterskip=5em]{chapter}

% decrease skip before \paragraph and \subparagraph headings
\RedeclareSectionCommand[beforeskip=2ex plus 1ex minus .2px]{paragraph}
\RedeclareSectionCommand[beforeskip=1ex plus 1ex minus .2px]{subparagraph}

\makeatletter

% append period to \paragraph headings
\let\paragraphwithoutperiod\paragraph
\newcommand*{\paragraphwithperiodwithstar}[1]{\paragraphwithoutperiod*{#1.}}
\newcommand*{\paragraphwithperiod}[1]{\paragraphwithoutperiod{#1.}}
\renewcommand*{\paragraph}{%
  \@ifstar{\paragraphwithperiodwithstar}{\paragraphwithperiod}%
}

% append period to \subparagraph headings
\let\subparagraphwithoutperiod\subparagraph
\newcommand*{\subparagraphwithperiodwithstar}[1]{\subparagraphwithoutperiod*{#1.}}
\newcommand*{\subparagraphwithperiod}[1]{\subparagraphwithoutperiod{#1.}}
\renewcommand*{\subparagraph}{%
\@ifstar{\subparagraphwithperiodwithstar}{\subparagraphwithperiod}%
}

\makeatother

% increase indentation of paragraphs (default: 1em = \quad)
\setlength{\parindent}{2em}

% ======================================================================
% Dictums
% ======================================================================

% don't use sans-serif font for dictums
\addtokomafont{dictum}{\rmfamily}

% format dictums with custom command
\renewcommand*{\dictum}[2][]{\cleanchapterquote{#2}{#1}}

% shortcut for setting the dictum for a chapter
\newcommand*{\setdictum}[2]{%
  \setchapterpreamble{%
    \dictum[#2]{#1}%
    \chapterheadendvskip%
  }%
}

% fancy quotes (taken from cleanthesis.sty, slightly adapted)
\newcommand*{\hugequote}{%
  \fontsize{75}{80}\selectfont%
  \hspace*{-0.6em}\color{lightgray}%
  \textit{``}%
  \vskip -0.8em%
}

\newcommand*{\cleanchapterquote}[2]{%
  \begin{minipage}{\textwidth}%
    \begin{flushright}
      \begin{minipage}{0.54\textwidth}%
        \begin{flushleft}
          {\hugequote}\textit{#1}
        \end{flushleft}
        \begin{flushright}
          \small--- #2
        \end{flushright}
      \end{minipage}%
    \end{flushright}
  \end{minipage}%
  \bigskip
}

% ======================================================================
% Page Headers and Footers
% ======================================================================

% all-caps sans-serif page header
\setkomafont{pageheadfoot}{%
  \normalfont\normalcolor\sffamily%
  \fontsize{9.5}{12}\selectfont\lsstyle%
}
\setkomafont{pagenumber}{\usekomafont{pageheadfoot}\bfseries}

% move page number to page header
\clearscrheadfoot
\lehead[\pagemark]{\pagemark}
\rehead[]{\headmark}
\lohead[]{\headmark}
\rohead[\pagemark]{\pagemark}
\lefoot[]{}
\rofoot[]{}

% prepend "Chapter X: " in front of the chapter name in page headers
\renewcommand*{\chaptermarkformat}{Chapter \thechapter: }

% ======================================================================
% Float Captions
% ======================================================================

% change font size for captions, add horizontal rule
\makeatletter
\DeclareCaptionFormat{mycaptionformat}{%
  \small\@hangfrom{#1#2}%
  \advance\caption@parindent\hangindent
  \advance\caption@hangindent\hangindent
  \caption@@par#3\par%
}
\makeatother

% special format for unnumbered figures (e.g., cover figure)
\DeclareCaptionLabelFormat{mycaptionlabelformatunnumbered}{%
  \sffamily\bfseries\fontsize{9.5}{12}\selectfont\textls*{\MakeUppercase{#1}}%
}

% change appearance of caption label
\DeclareCaptionLabelFormat{mycaptionlabelformat}{%
  \sffamily\bfseries\fontsize{9.5}{12}\selectfont\textls*{\MakeUppercase{#1}} #2%
}

% set caption format
\captionsetup{
  % use custom format
  format=mycaptionformat,
  % use custom label format
  labelformat=mycaptionlabelformat,
  % separate number and caption with \quad
  labelsep=quad,
}

% don't indent caption text in SCfigure (figures with side caption)
\DeclareCaptionFormat{mysidecaptionformat}{\small#1#2\\#3\par}
\AtBeginEnvironment{SCfigure}{\captionsetup{format=mysidecaptionformat}}
\AtBeginEnvironment{SCtable}{\captionsetup{format=mysidecaptionformat}}

% change font size for sub-captions
\makeatletter
\DeclareCaptionFormat{mysubcaptionformat}{%
  \fontsize{10}{12}\selectfont\@hangfrom{#1#2}%
  \advance\caption@parindent\hangindent
  \advance\caption@hangindent\hangindent
  \caption@@par#3\par%
}
\makeatother

% change appearance of sub-caption label
\DeclareCaptionLabelFormat{mysubcaptionlabelformat}{%
  \sffamily\bfseries\fontsize{8.8}{11}\selectfont\textls*{\MakeUppercase{#2}}%
}

% set sub-caption format
\captionsetup[sub]{
  % use custom format
  format=mysubcaptionformat,
  % use custom label format
  labelformat=mysubcaptionlabelformat,
  % separate number and caption with \quad
  labelsep=quad,
}

% ======================================================================
% Algorithms
% ======================================================================

% disable ligatures ("fi" etc.) in monospace font
\DisableLigatures{encoding=*,family=tt*}

% line number format
\algrenewcommand{\alglinenumber}[1]{\footnotesize\color{anthrazit}{\texttt{#1}}}
\algrenewcommand{\algorithmicrequire}{\textbf{Input:}}
\algrenewcommand{\algorithmicensure}{\textbf{Output:}}

% function name
\algrenewcommand{\textproc}{}

% bold keywords
\algnewcommand{\Break}{\textbf{break}}
\algnewcommand{\Continue}{\textbf{continue}}
\algnewcommand{\True}{\textbf{true}}
\algnewcommand{\False}{\textbf{false}}
\algnewcommand{\Null}{\textbf{null}}
\algrenewcommand{\algorithmicend}{\textbf{end}}
\algrenewcommand{\algorithmicdo}{\textbf{do}}
\algrenewcommand{\algorithmicwhile}{\textbf{while}}
\algrenewcommand{\algorithmicfor}{\textbf{for}}
\algrenewcommand{\algorithmicforall}{\textbf{for all}}
\algrenewcommand{\algorithmicloop}{\textbf{loop}}
\algrenewcommand{\algorithmicrepeat}{\textbf{repeat}}
\algrenewcommand{\algorithmicuntil}{\textbf{until}}
\algrenewcommand{\algorithmicprocedure}{\textbf{procedure}}
\algrenewcommand{\algorithmicfunction}{\textbf{function}}
\algrenewcommand{\algorithmicif}{\textbf{if}}
\algrenewcommand{\algorithmicthen}{\textbf{then}}
\algrenewcommand{\algorithmicelse}{\textbf{else}}
\algrenewcommand{\algorithmicreturn}{\textbf{return}}
\algnewcommand{\algorithmicforever}{\textbf{for ever}}
\algdef{S}[FOR]{ForEver}{\algorithmicforever\ \algorithmicdo}
\algnewcommand{\algorithmicgoto}{\textbf{go to}}
\algnewcommand{\Goto}[1]{\algorithmicgoto\ \cref*{#1}}

% small monospace font in algorithms
\makeatletter
\g@addto@macro\ALG@beginalgorithmic{\small\ttfamily}
\makeatother

% comment format
\algrenewcomment[1]{\hfill$\rightsquigarrow$ \emph{\normalfont#1}}

% declare algorithm float environment
\DeclareNewTOC[
  type=algorithm,
  name=Algorithm,
  float,
  floattype=4,
  counterwithin=chapter,
]{loa}

% ======================================================================
% Tables
% ======================================================================

% fixed-width column types with left, center, and right alignment
\newcolumntype{L}[1]{%
  >{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}%
}
\newcolumntype{C}[1]{%
  >{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}%
}
\newcolumntype{R}[1]{%
  >{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}%
}

% ======================================================================
% Floats
% ======================================================================

% automatically center all float and subfigure contents
\makeatletter
\g@addto@macro{\@floatboxreset}{\centering}
\apptocmd\subcaption@minipage{\centering}{}{}
\makeatother

% change font size in float environments
\makeatletter
\g@addto@macro{\figure}{\small}
\g@addto@macro{\table}{\small}
\g@addto@macro{\algorithm}{\small}
\makeatother

% don't move floats to own page (float page) when they are tall,
% the default value is 0.5, which is a bit small
\renewcommand*{\floatpagefraction}{0.7}

% space between floats and text
\setlength{\textfloatsep}{40pt}

% height of ornament
\newcommand*{\myornamentheight}{8pt}
% center ornament vertically
\newcommand*{\myornamentmargin}{%
  \dimexpr\textfloatsep/2-\myornamentheight/2\relax%
}
% load ornament image
\pgfSetupImageAsPattern[height=\myornamentheight]{myornament}{../gfx/ornament}

% separate floats from text with an ornament line
\newcommand*{\topfigrule}{%
  {%
    \color{black}%
    \vspace{\myornamentmargin}%
    \noindent%
    \begin{tikzpicture}[use image as pattern=myornament]
      \draw[draw=none,image as pattern={center,bottom}]
        (0,0) rectangle (\textwidth,\myornamentheight);
    \end{tikzpicture}%
    \vspace{-\myornamentmargin}%
    \vspace{-\myornamentheight}%
  }%
}

% ======================================================================
% Theorems
% ======================================================================

% define mdframed style for theorems (left rule)
\mdfdefinestyle{mymdfstyle}{
  hidealllines=true,
  leftline=true,
  innerleftmargin=10pt,
  innerrightmargin=0pt,
  innertopmargin=-1pt,
  innerbottommargin=0pt,
  linewidth=2pt,
  linecolor=anthrazit,
}

% define theorem styles (format theorem "head" with sans-serif caps)
\declaretheoremstyle[
  headfont={\sffamily\bfseries\fontsize{9.5}{12}\selectfont},
  headformat={\textls*{\MakeUppercase{\NAME{} \NUMBER}}\hspace{0.7em}\NOTE\\},
  notefont={\normalfont\normalsize},
  headpunct={},
]{mythmdefstyle}

% same as before, but italic body font
\declaretheoremstyle[
  headfont={\sffamily\bfseries\fontsize{9.5}{12}\selectfont},
  headformat={\textls*{\MakeUppercase{\NAME{} \NUMBER}}\hspace{0.7em}\NOTE\\},
  notefont={\normalfont\normalsize},
  headpunct={},
  bodyfont={\itshape},
]{mythmplainstyle}

% same as before, but no note and line break after head
\declaretheoremstyle[
  headfont={\sffamily\bfseries\fontsize{9.5}{12}\selectfont},
  headformat={\textls*{\MakeUppercase{\NAME{} \NUMBER}}\hspace{0.7em}},
  notefont={\normalfont\normalsize},
  headpunct={},
  bodyfont={\itshape},
]{mythmshortplainstyle}

% theorem environments
\declaretheorem[
  name={Definition},
  numberwithin=chapter,
  mdframed={style=mymdfstyle},
  style=mythmdefstyle,
]{definition}
\declaretheorem[
  name={Theorem},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{theorem}
\declaretheorem[
  name={Proposition},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{proposition}
\declaretheorem[
  name={Lemma},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{lemma}
\declaretheorem[
  name={Corollary},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmplainstyle,
]{corollary}
\declaretheorem[
  name={Corollary},
  numberlike=definition,
  mdframed={style=mymdfstyle},
  style=mythmshortplainstyle,
]{shortcorollary}

% use tcolorbox for dashed rule near proofs
\tcolorboxenvironment{proof}{
  blanker,
  before skip=1.5em,
  after skip=\topsep,
  borderline west={2pt}{0pt}{anthrazit,dashed},
  breakable,
  left=12pt,
}

% ======================================================================
% Mathematics
% ======================================================================

% vertically center ":" in ":="
\mathtoolsset{centercolon}

% automatically replace "l" with \ell in math mode
\mathcode`l="8000
\makeatletter
\begingroup
\lccode`\~=`\l
\DeclareMathSymbol{\lsb@l}{\mathalpha}{letters}{`l}
\lowercase{\gdef~{\ifnum\the\mathgroup=\m@ne \ell \else \lsb@l \fi}}%
\endgroup
\makeatother

% change QED symbol to not confuse non-mathematicians
\renewcommand*{\qedsymbol}{\textit{Q.E.D.}}

% ======================================================================
% Blindtext
% ======================================================================

% get name of current label (chapter, section, subsection, ...)
\makeatletter
\newcommand*{\currentname}{\@currentlabelname}
\makeatother

% insert TODO and warn for every usage of \blindtext
\let\oldblindtext\blindtext
\renewcommand*{\blindtext}{%
  \todo{write}
  \textcolor{gray}{\oldblindtext}%
}

% ======================================================================
% Dynamic Commands
% ======================================================================

% calculate difference between page numbers
\newcommand*{\pagedifference}[2]{%
  \number\numexpr\getpagerefnumber{#2}-\getpagerefnumber{#1}\relax%
}

% custom TODO command with warning
% (all packages that were tried produced problems)
\newcommand*{\todo}[1]{%
  \GenericWarning{}{%
    LaTeX Warning (\thesubsection\space\currentname): TODO "#1"%
  }%
  \textcolor{red}{TODO: #1}%
}

% set up versioning information
\luaexec{require("version")}
\edef\gitCommitHash{\luadirect{getGitCommitHash()}}
\edef\gitCommitTimeShort{\luadirect{getGitCommitTimeShort()}}
\edef\gitCommitTimeLong{\luadirect{getGitCommitTimeLong()}}
\edef\currentTimeShort{\luadirect{getCurrentTimeShort()}}
\edef\currentTimeLong{\luadirect{getCurrentTimeLong()}}
\edef\compileCounter{\luadirect{getAndIncreaseCompileCounter()}}

% command for checking if file is in includeonly or not
\makeatletter
\newcommand*{\isincluded}[1]{%
  \@tempswatrue
  \if@partsw
    \@tempswafalse
    \edef\reserved@b{#1}%
    \@for\reserved@a:=\@partlist\do
    {\ifx\reserved@a\reserved@b\@tempswatrue\fi}%
  \fi
  \if@tempswa\expandafter\@firstoftwo\else\expandafter\@secondoftwo\fi
}
\makeatother

% ======================================================================
% Colors
% ======================================================================

% define line colors (mix between MATLAB and matplotlib colors)
\definecolor{C0}{rgb}{0.000,0.447,0.741}
\definecolor{C1}{rgb}{0.850,0.325,0.098}
\definecolor{C2}{rgb}{0.929,0.694,0.125}
\definecolor{C3}{rgb}{0.494,0.184,0.556}
\definecolor{C4}{rgb}{0.466,0.674,0.188}
\definecolor{C5}{rgb}{0.301,0.745,0.933}
\definecolor{C6}{rgb}{0.635,0.078,0.184}
\definecolor{C7}{rgb}{0.887,0.465,0.758}
\definecolor{C8}{rgb}{0.496,0.496,0.496}

% define university CD colors
\definecolor{anthrazit}{RGB}{62,68,76}
\definecolor{mittelblau}{RGB}{0,81,158}
\definecolor{helllblau}{RGB}{0,190,255}

% ======================================================================
% Check Mode
% ======================================================================

% check mode
\iftoggle{checkMode}{
  % show overfull boxes
  \overfullrule=1mm
  % whitelist is in hyphenation_whitelist.txt:
  % one word per line (all lowercase) with dashes (-) indicating the
  % places where hyphenation is permitted
  \LuaCheckHyphen{whitelist=hyphenation_whitelist.txt}
}{}

% ======================================================================
% Flip Book
% ======================================================================

% prevent "Label `1' multiply defined" warnings when using
% KOMA-Script's \ifthispageodd together with \includeonly
\makeatletter
\newcounter{scbookpg}
\renewcommand*{\is@thispageodd}{%
  \@bsphack
  \begingroup
    %\@tempcnta=\scr@tpo
    %\advance\@tempcnta by\@ne
    \stepcounter{scbookpg}%
    \xdef\scr@tpo{\thescbookpg}%
    \protected@write\@auxout{\let\arabic\relax}{%
      \string\new@tpo@label{\scr@tpo}{\arabic{page}}}%
    \expandafter\ifx\csname tpo@\scr@tpo\endcsname\relax
      \protect\G@refundefinedtrue
      \ClassWarning{\KOMAClassName}{%
        odd/even page label number \scr@tpo\space undefined}%
      \edef\@tempa{\the\value{page}}%
    \else
      \edef\@tempa{\csname tpo@\scr@tpo\endcsname}%
    \fi
    \ifodd\number\@tempa
      \aftergroup\thispagewasoddtrue
    \else
      \aftergroup\thispagewasoddfalse
    \fi
  \endgroup
  \@esphack
}
\makeatletter

% set up flip book
\iftoggle{flipBookMode}{
  \newcounter{currentpagenumber}
  \iftoggle{partialCompileMode}{}{
    % start flip book after second title page
    \setcounter{currentpagenumber}{-4}
  }
  \newcount\flipbookindex
  
  \AddEverypageHook{%
    \stepcounter{currentpagenumber}%
    \flipbookindex=\numexpr\thecurrentpagenumber/2\relax%
    \ifnum\number\flipbookindex>0%
      \begin{tikzpicture}[remember picture,overlay,scale=1]
        \ifthispageodd{
          \node[anchor=south east,inner sep=0pt,xshift=0mm,yshift=-3mm]
          at (current page.south east) [above left] {%
            \includegraphics[scale=0.8]{flipBookSG_\number\flipbookindex}%
          };
        }{
          \node[anchor=south west,inner sep=0pt,xshift=-6mm,yshift=2mm]
          at (current page.south west) [above right] {%
            \includegraphics{flipBookBSpline_\number\flipbookindex}%
          };
        }
      \end{tikzpicture}%
    \fi%
  }
}{}

% ======================================================================
% Watermarks
% ======================================================================

% set up watermarks
\iftoggle{draftMode}{
  \AddEverypageHook{%
    \begin{tikzpicture}[remember picture,overlay,scale=1]
      \node[
        opacity=0.5,anchor=center,xshift=0mm,yshift=7mm,inner sep=0pt,
      ] at (current page.south) [above] {
        \parbox{100mm}{%
          \begin{center}%
            \onehalfspacing\bfseries\color{black}%
            Draft \texttt{v\compileCounter{}} (\currentTimeShort)\\%
            Commit \texttt{\gitCommitHash{}} (\gitCommitTimeShort)%
          \end{center}%
        }%
      };
      \ifthispageodd{
        \node[
          opacity=0.5,anchor=north east,xshift=-15mm,yshift=-38.5mm,
          inner sep=0pt,text width=4.51mm,align=right,
        ] at (current page.north east) [below left] {%
          \ttfamily\onehalfspacing%
          1\\2\\3\\4\\5\\6\\7\\8\\9\\10\\%
          11\\12\\13\\14\\15\\16\\17\\18\\19\\20\\%
          21\\22\\23\\24\\25\\26\\27\\28\\29\\30\\%
          31\\32\\33\\34\\35\\36\\37\\%
        };
      }{
        \node[
          opacity=0.5,anchor=north west,xshift=15mm,yshift=-38.5mm,color=black,
          inner sep=0pt,text width=4.51mm,align=right,
        ] at (current page.north west) [below right] {%
          \ttfamily\onehalfspacing%
          1\\2\\3\\4\\5\\6\\7\\8\\9\\10\\%
          11\\12\\13\\14\\15\\16\\17\\18\\19\\20\\%
          21\\22\\23\\24\\25\\26\\27\\28\\29\\30\\%
          31\\32\\33\\34\\35\\36\\37\\%
        };
      }
    \end{tikzpicture}%
  }
}{}

% ======================================================================
% PDF Meta-Data and Links
% ======================================================================

% set up hyperref
\hypersetup{
  % set metadata
  pdftitle={\thetitle},
  pdfauthor={\theauthor},
  pdfcreator={LaTeX, KOMA-Script, hyperref},
  % underline links instead of putting a framed box around them
  pdfborderstyle={/S/U/W 1},
  % set link colors
  citebordercolor=C1,
  filebordercolor=C1,
  linkbordercolor=C1,
  menubordercolor=C1,
  runbordercolor=C1,
  urlbordercolor=C0,
  % prepend bookmarks with section number
  bookmarksnumbered,
  % open bookmark tree on start
  bookmarksopen,
}

% include parentheses of \eqref in hyperlink
\makeatletter
\renewcommand*{\eqref}[1]{\hyperref[{#1}]{\textup{\tagform@{\ref*{#1}}}}}
\makeatother

% ======================================================================
% Bibliography
% ======================================================================

% break URLs after every character (most importantly for bibliography)
\luaexec{require("breakurl")}
\let\oldhref\href
\renewcommand*{\url}[1]{\luadirect{breakurl(\luastringN{#1}, \luastringN{#1})}}
\renewcommand*{\href}[2]{\luadirect{breakurl(\luastringN{#1}, \luastringN{#2})}}

% location of *.bib file
\addbibresource{../bib/bibliography.bib}

% don't append "+" sign to BibLaTeX citations in alphabetic style
\renewcommand*{\labelalphaothers}{}

% insert colon after author names in bibliography
\renewcommand*{\labelnamepunct}{: }

% hide urldate field
\AtEveryBibitem{\clearfield{urlyear}}

% make paper titles italic, remove quotation marks
\DeclareFieldFormat[article]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[article]{journaltitle}{#1}
\DeclareFieldFormat[thesis]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[inbook]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[inbook]{booktitle}{#1}
\DeclareFieldFormat[incollection]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[incollection]{booktitle}{#1}
\DeclareFieldFormat[inproceedings]{title}{\mkbibemph{#1}}
\DeclareFieldFormat[inproceedings]{booktitle}{#1}
\DeclareFieldFormat[unpublished]{title}{\mkbibemph{#1}}

% fix title capitalization to sentence case (all lowercase),
\DeclareFieldFormat{titlecase}{\MakeTitleCase{#1}}

% .. but don't change journal titles, book titles, and so on
\newrobustcmd{\MakeTitleCase}[1]{%
  \ifthenelse{%
    \ifcurrentfield{booktitle}\OR\ifcurrentfield{booksubtitle}%
    \OR\ifcurrentfield{maintitle}\OR\ifcurrentfield{mainsubtitle}%
    \OR\ifcurrentfield{journaltitle}\OR\ifcurrentfield{journalsubtitle}%
    \OR\ifcurrentfield{issuetitle}\OR\ifcurrentfield{issuesubtitle}%
    \OR\ifentrytype{book}\OR\ifentrytype{mvbook}\OR\ifentrytype{bookinbook}%
    \OR\ifentrytype{booklet}\OR\ifentrytype{suppbook}%
    \OR\ifentrytype{collection}\OR\ifentrytype{mvcollection}%
    \OR\ifentrytype{suppcollection}\OR\ifentrytype{manual}%
    \OR\ifentrytype{periodical}\OR\ifentrytype{suppperiodical}%
    \OR\ifentrytype{proceedings}\OR\ifentrytype{mvproceedings}%
    \OR\ifentrytype{reference}\OR\ifentrytype{mvreference}%
    \OR\ifentrytype{report}\OR\ifentrytype{thesis}%
  }{%
    #1%
  }{%
    \MakeSentenceCase*{#1}%
  }%
}

% suppress "In:" before journal names
\renewbibmacro*{in:}{}

% separate authors with semicolon, suppress "and" in author names
\renewcommand{\multinamedelim}{\addsemicolon\space}
\renewcommand*{\finalnamedelim}{\addsemicolon\space}

% make names bold
\renewcommand*{\mkbibnamefamily}[1]{\textbf{#1}}

\DeclareNameAlias{sortname}{last-first}
\DeclareNameAlias{default}{last-first}

% define custom heading to fix non-uppercase page header, make URLs smaller
\defbibheading{myheading}[\bibname]{%
  \chapter{#1}%
  \markboth{BIBLIOGRAPHY}{BIBLIOGRAPHY}%
  \let\oldtexttt\texttt%
  \renewcommand*{\texttt}[1]{\oldtexttt{\scriptsize##1}}%
}

% add custom bibliography post note (URLs last checked on ...)
\defbibnote{mypostnote}{%
  All URLs have last been checked on \thedate.%
  \renewcommand*{\texttt}[1]{\oldtexttt{##1}}%
}

% omit "URL:" and "DOI:" separators to save space
\DeclareFieldFormat{url}{\url{#1}}
\DeclareFieldFormat{doi}{%
  \ifhyperref{\href{https://doi.org/#1}{\nolinkurl{#1}}}{\nolinkurl{#1}}%
}

% change font size of bibliography
\renewcommand*{\bibfont}{\small}

% set single line spacing for bibliography
\renewcommand*{\bibsetup}{\singlespacing}

% ======================================================================
% Glossary
% ======================================================================

\makeatletter

% \newcommand with variable command names
\newcommand*{\newnamecommand}{\@star@or@long\new@name@command}
\newcommand*{\new@name@command}[1]{\expandafter\new@command\csname #1\endcsname}

\iftoggle{partialCompileMode}{
  \newcommand*{\newgsymbol}[3]{}
  \newcommand*{\newgacronym}[3]{\newnamecommand{#1}{#2\xspace}}
}{
  % define new glossary style based on long (uses longtable)
  % in which the column widths are fixed and space before/after the
  % table is removed
  \newglossarystyle{longraggedfixed}{%
    \setglossarystyle{long}%
    \renewenvironment{theglossary}%
    {%
      \setlength{\LTpre}{0pt}%
      \setlength{\LTpost}{0pt}%
      \begin{spacing}{1}%
        \begin{longtable}{@{}L{0.15\textwidth}@{}L{0.85\textwidth}@{}}%
          \textbf{Symbol}\vspace{2mm}&%
          \textbf{Meaning\hfill{}Page(s) with Explanation}\vspace{2mm}%
          \endhead%
    }%
    {%
        \end{longtable}%
      \end{spacing}%
    }%
    \renewcommand*{\glossentry}[2]{%
      \glsentryitem{##1}\glstarget{##1}{\glossentryname{##1}}&%
      \glossentrydesc{##1}\leavevmode\kern3pt\leaders\hbox{%
        \hspace{0.25em}.\hspace{0.25em}%
      }\hfill\kern0pt%
      ##2%
      \tabularnewline%
    }%
  }
  
  % use new glossary style
  \setglossarystyle{longraggedfixed}
  
  % shortcut for \newglossaryentry + \gls
  \newcommand*{\newgsymbol}[3]{%
    \newglossaryentry{#1}{sort={#1},name={#2},description={#3},text={}}%
    % only reference the entry if not in preamble
    \ifx\@onlypreamble\@notprerr\gls{#1}\fi%
  }
  
  % shortcut for \newacronym, automatically generating
  % a corresponding shortcut for \gls
  \newcommand*{\newgacronym}[3]{%
    \newacronym[sort={#1},description={\makefirstuc{#3}}]{#1}{#2}{#3}%
    \newnamecommand{#1}{\gls{#1}\xspace}%
    \newnamecommand{#1s}{\glspl{#1}\xspace}%
    \newnamecommand{#1c}{\Gls{#1}\xspace}%
    \newnamecommand{#1sc}{\Glspl{#1}\xspace}%
  }
  
  % shortcut for \newgacronym wihout displaying an entry in the glossary
  \newignoredglossary{hidden}
  \newcommand*{\newghiddenacronym}[3]{%
    \newgacronym{#1}{#2}{#3}%
    \glsmoveentry{#1}{hidden}%
  }
  
  % spell out acronyms at beginning of chapters and sections
  \addtokomafont{chapter}{\glsresetall}
  \addtokomafont{section}{\glsresetall}
  
  % generate table of symbols and acronyms
  \makeglossaries
}

% add debug info about definitions of glossary entries
\iftoggle{showGlossaryDefinitionsMode}{
  \let\oldnewgsymbol\newgsymbol
  \renewcommand*{\newgsymbol}[3]{%
    \ifx\@onlypreamble\@notprerr%
      \textcolor{C1}{Defining ``#2'' as ``#3''. }%
    \fi%
    \oldnewgsymbol{#1}{#2}{#3}%
  }
}{}

\makeatother
