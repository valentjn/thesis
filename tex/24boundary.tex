\section{Boundary Treatment}
\label{sec:24boundary}

One issue of regular sparse grids $\Omega_{n,d}^\sparse$ as we have defined them
is that the number of grid points still grows very fast
with the level $n$ and the dimensionality $d$.
This is mainly because the finest mesh size $h_n$ on the
boundary of the domain $[\ß0, \ß1]$ is finer than
the finest mesh size $h_{n-d+1}$ that can be found in the interior.
\newgsymbol{Omegaso}{$\interior{\Omega}^\sparse$}{%
  Interior grid points $:= \Omega^\sparse \cap \openinterval{\ß0, \ß1}$
  for a finite set $\Omega^\sparse \subset [\ß0, \ß1]$ of grid points%
}%
\newgsymbol{01o!}{$\openinterval{\ß0, \ß1}$}{%
  Open unit hypercube $:= \openinterval{0, 1}^d := \{x \in \RR \mid 0 < x < 1\}^d$%
}%
If we define $\interior{\Omega}_{n,d}^\sparse$ as the set of
interior grid points in $\Omega_{n,d}^\sparse$, i.e.,%
\footnote{%
  Note that in the literature,
  the regular sparse grid space of level $n$ without boundary points is often
  defined via $\norm{\ßl}_1 \le n + d - 1$ to ensure that the finest mesh size
  is given by $h_n$.
  In our notation, this corresponds to $\interior{\Omega}_{n+d-1,d}^\sparse$.%
}
\begin{equation}
  \interior{\Omega}_{n,d}^\sparse
  := \Omega_{n,d}^\sparse \cap \openinterval{\ß0, \ß1}
  = \{\ßx_{\ßl,\ßi} \in \Omega_{n,d}^\sparse \mid \ßl \ge \ß1\},
\end{equation}
then the following relation about the number of grid points
of $\Omega_{n,d}^\sparse$ can be shown:
\begin{lemma}[number of grid points of $\Omega_{n,d}^\sparse$]
  \label{lemma:numberOfGridPointsBoundary}
  \setlength{\abovedisplayskip}{0pt}
  \begin{equation}
    |\Omega_{n,d}^\sparse|
    = \sum_{q=0}^d 2^q \binom{d}{q} |\interior{\Omega}_{n+q,d-q}^\sparse|
  \end{equation}
\end{lemma}
\begin{proof}
  See \cite{Bungartz04Sparse}.
\end{proof}
Here, we define $0$-dimensional grids to contain exactly one grid point
(the empty tuple).
The number of interior grid points can be calculated as follows:
\begin{lemma}[number of grid points of $\interior{\Omega}_{n,d}^\sparse$]
  \label{lemma:numberOfGridPointsInterior}
  \setlength{\abovedisplayskip}{0pt}
  \begin{equation}
    |\interior{\Omega}_{n,d}^\sparse|
    = \sum_{q=0}^{n-d} 2^q \binom{d-1+q}{d-1}
  \end{equation}
\end{lemma}
\begin{proof}
  See \cite{Bungartz04Sparse}.
\end{proof}

Intuitively, \cref{lemma:numberOfGridPointsBoundary} splits the sparse grid
$\Omega_{n,d}^\sparse$ into lower-dimensional sparse grids
$\interior{\Omega}_{n+q,d-q}^\sparse$ without boundary points.
The factor $2^q \binom{d}{q}$ is the number of $(d-q)$-dimensional faces
of the $d$-dimensional unit hypercube.
For example, the 3D cube decomposes into
$2^0 \binom{3}{0} = 1$ interior cube $\openinterval{0, 1}^3$,
$2^1 \binom{3}{1} = 6$ sides ($2$-dimensional faces)
like $\openinterval{0, 1}^2 \times \{0\}$,
$2^2 \binom{3}{2} = 12$ edges ($1$-dimensional faces)
like $\openinterval{0, 1} \times \{(0, 0)\}$, and
$2^3 \binom{3}{3} = 8$ corners ($0$-dimensional faces)
like $(0, 0, 0)$.
On each of these $(d-q)$-dimensional faces,
the sparse grid $\Omega_{n,d}^\sparse$ contains
the interior of a sparse grid of level $n + q$,
the size of which grows like $\calO(2^{n+q} n^{d-q-1})$.
As the number of boundary faces increases exponentially
with the dimensionality $d$,
the size of $\Omega_{n,d}^\sparse$ quickly exhausts the available
computational memory.
There are mainly two solutions to deal with this issue.

\subsection{Sparse Grids with Coarser Boundaries}

\paragraph{Inserting boundary points at finer levels}

The first solution is to insert the boundary level functions and grid points
at a finer level than $0$.
A popular choice is the insertion at level $1$, which corresponds to
\begin{equation}
  \label{eq:sparseGridB1}
  \Omega_{n,d}^{\sparse(1)}
  := \bigdotcup_{\ßl \in L_{n,d}^{\sparse(1)}}
  \{\ßx_{\ßl,\ßi} \mid \ßi \in I_\ßl\},\quad
  L_{n,d}^{\sparse(1)}
  := \{\ßl \in \NN_0^d \mid \norm{\vecmax(\ßl, \ß1)}_1 \le n\},
\end{equation}
where $\vec{\max}$ is to be read coordinate-wise as usual.
This choice is equivalent to treating $0$-level components as level $1$
in the subspace selection.
This ensures that the finest mesh sizes in interior of $[\ß0, \ß1]$ and
its boundary coincide to be $h_{n-d+1}$, which reduces the number of grid points
on the boundary significantly.

Another solution that can be found in the literature about sparse grids with
hat functions is (in the univariate case)
to start with the constant function on level $0$ with
corresponding grid point $0.5$,
then employ the two boundary functions and points on level $1$,
and finally proceed as usual for the finer levels $\ge 2$.
Apart from a constant shift in the level of the resulting sparse grids,
this is equivalent to inserting the boundary functions and points at level $2$.
This solution leads to even less grid points than the previous approach,
as now the mesh size is finer in the interior of the domain than on the
boundary.
However, for very high dimensionalities this might still lead to
computationally infeasible sparse grids.

\paragraph{Regular sparse grids with coarse boundaries}

\newgsymbol{.sb}{$\cdot^{\sparse(b)}$}{%
  Superscript for ``sparse grid with boundary parameter $b$
  (grid point set/function space/interpolant)''%
}%
We generalize these two solutions to the definition of a
sparse grid $\Omega_{n,d}^{\sparse(b)}$ that is equivalent to inserting
the boundary functions and points at a level $b \in \NN$:
\begin{definition}[regular sparse grid with coarse boundary]
  \label{def:coarseBoundary}
  The regular sparse grid of level $n \ge d$,
  dimensionality $d \in \NN$, and boundary parameter $b \in \NN$ is defined as
  \begin{equation}
    \label{eq:coarseBoundary}
    \begin{split}
      \Omega_{n,d}^{\sparse(b)}
      := \bigdotcup_{\ßl \in L_{n,d}^{\sparse(b)}}
      \{\ßx_{\ßl,\ßi} \mid \ßi \in I_\ßl\},&\quad
      L_{n,d}^{\sparse(b)}
      := \{\ßl \in \NN^d \mid \norm{\ßl}_1 \le n\} \dotcup {}\\[-1em]
      &\big(\{\ßl \in \NN_0^d \setminus \NN^d \mid
      \norm{\vecmax(\ßl, \ß1)}_1 \le n-b+1\} \cup \{\ß0\}\big).
    \end{split}
  \end{equation}
  For convenience, we define
  $\Omega_{n,d}^{\sparse(0)} := \Omega_{n,d}^\sparse$.
\end{definition}
The definition is motivated by partitioning the levels $\ßl \in \NN_0^d$
into interior levels ($\ßl \in \NN^d$)
and boundary levels ($\ßl \in \NN_0^d \setminus \NN^d$).
By including the levels of the interior grid $\interior{\Omega}_{n,d}^\sparse$,
the mesh size in the interior is the same as before ($h_{n-d+1}$).
Like in \eqref{eq:sparseGridB1}, we treat boundary levels as level $1$,
but we subtract $b - 1$ from the upper bound to ensure the correct
mesh size $h_{n-d-b+2}$ on the boundary.
We append $\ß0$ to the level set to ensure that at least the $2^d$ corner
points are included in the resulting sparse grid.
Note that this definition is consistent with \eqref{eq:sparseGridB1} as
$L_{n,d}^{\sparse(b)}
= \{\ßl \in \NN_0^d \mid \norm{\vecmax(\ßl, \ß1)}_1 \le n\}$
for $b = 1$.
Examples of $\Omega_{n,d}^{\sparse(b)}$ are shown
in \cref{fig:coarseBoundary}.
The flip book animation in the bottom right corner of the pages of this thesis
visualizes $\Omega_{n,d}^{\sparse(b)}$ for $n = 4$, $d = 3$, and $b = 1$.

The number of grid points of $\Omega_{n,d}^{\sparse(b)}$
can be calculated as follows:
\begin{restatable}[number of grid points of $\Omega_{n,d}^{\sparse(b)}$]{%
  proposition%
}{%
  propGridSizeCoarseBoundary%
}
  \label{prop:gridSizeCoarseBoundary}
  \label{PROP:GRIDSIZECOARSEBOUNDARY}
  \setlength{\abovedisplayskip}{0pt}
  \begin{equation}
    |\Omega_{n,d}^{\sparse(b)}|
    = |\interior{\Omega}_{n,d}^\sparse| +
    \sum_{q=1}^d 2^q \binom{d}{q}
    |\interior{\Omega}_{n-q-b+1,d-q}^\sparse|,\quad
    b \in \NN
  \end{equation}
\end{restatable}
\begin{proof}
  See \cref{sec:proofGridSizeCoarseBoundary}.
\end{proof}
As can be seen in \cref{tbl:coarseBoundary3D} for three dimensions and
in \cref{tbl:coarseBoundary10D} for ten dimensions,
the number of grid points decreases drastically for increasing values
of $b$, especially when compared with
$\Omega_{n,d}^\sparse = \Omega_{n,d}^{\sparse(0)}$.

\begin{table}
  \begin{tabular}{l@{\hspace{10mm}}r@{\hspace{10mm}}rrrrrr}
    \toprule
    &
    {$|\interior{\Omega}_{n,d}^\sparse|$}&
    {$b = 0$}&
    {$b = 1$}&
    {$b = 2$}&
    {$b = 3$}&
    {$b = 4$}&
    {$b = 5$}\\
    \midrule
    $n = 3$&
    \num{1}&
    \num{123.0}&
    \num{27.0}&
    \num{9.00}&
    \num{9.00}&
    \num{9.00}&
    \num{9.00}\\
    $n = 4$&
    \num{7}&
    \num{42.4}&
    \num{11.6}&
    \num{4.71}&
    \num{2.14}&
    \num{2.14}&
    \num{2.14}\\
    $n = 5$&
    \num{31}&
    \num{22.7}&
    \num{7.3}&
    \num{3.39}&
    \num{1.84}&
    \num{1.26}&
    \num{1.26}\\
    $n = 6$&
    \num{111}&
    \num{14.9}&
    \num{5.3}&
    \num{2.75}&
    \num{1.67}&
    \num{1.23}&
    \num{1.07}\\
    $n = 7$&
    \num{351}&
    \num{10.9}&
    \num{4.3}&
    \num{2.37}&
    \num{1.55}&
    \num{1.21}&
    \num{1.07}\\
    $n = 8$&
    \num{1023}&
    \num{8.5}&
    \num{3.6}&
    \num{2.13}&
    \num{1.47}&
    \num{1.19}&
    \num{1.07}\\
    $n = 9$&
    \num{2815}&
    \num{7.0}&
    \num{3.2}&
    \num{1.96}&
    \num{1.41}&
    \num{1.17}&
    \num{1.07}\\
    $n = 10$&
    \num{7423}&
    \num{6.0}&
    \num{2.9}&
    \num{1.83}&
    \num{1.36}&
    \num{1.16}&
    \num{1.06}\\
    \bottomrule
  \end{tabular}
  \caption{%
    For $d = 3$:
    Grid size of the interior grid
    $\interior{\Omega}_{n,d}^\sparse$ for \emph{(second column)}
    and ratios
    $|\Omega_{n,d}^{\sparse(b)}|/|\interior{\Omega}_{n,d}^\sparse|$
    \emph{(beginning with third column)} of the sizes of
    the grid $\Omega_{n,d}^{\sparse(b)}$ with boundary points
    to the size of the interior grid of the same level.
    The table begins at the first level $n = 3$ for which
    the interior grid $\interior{\Omega}_{n,d}^\sparse$ is not empty.%
  }
  \label{tbl:coarseBoundary3D}
\end{table}

\begin{table}
  \begin{tabular}{l@{\hspace{10mm}}r@{\hspace{10mm}}rrrrrr}
    \toprule
    &
    {$|\interior{\Omega}_{n,d}^\sparse|$}&
    {$b = 0$}&
    {$b = 1$}&
    {$b = 2$}&
    {$b = 3$}&
    {$b = 4$}&
    {$b = 5$}\\
    \midrule
    $n = 10$&
    \num{1}&
    \num{3.3e+08}&
    \num{59049}&
    \num{1025}&
    \num{1025.0}&
    \num{1025.0}&
    \num{1025.0}\\
    $n = 11$&
    \num{21}&
    \num{4.3e+07}&
    \num{21558}&
    \num{2813}&
    \num{49.8}&
    \num{49.8}&
    \num{49.8}\\
    $n = 12$&
    \num{241}&
    \num{1.0e+07}&
    \num{10046}&
    \num{1879}&
    \num{246.0}&
    \num{5.2}&
    \num{5.2}\\
    $n = 13$&
    \num{2001}&
    \num{3.4e+06}&
    \num{5407}&
    \num{1211}&
    \num{227.2}&
    \num{30.5}&
    \num{1.5}\\
    $n = 14$&
    \num{13441}&
    \num{1.3e+06}&
    \num{3213}&
    \num{806}&
    \num{181.1}&
    \num{34.7}&
    \num{5.4}\\
    $n = 15$&
    \num{77505}&
    \num{6.2e+05}&
    \num{2054}&
    \num{558}&
    \num{140.6}&
    \num{32.2}&
    \num{6.8}\\
    $n = 16$&
    \num{397825}&
    \num{3.1e+05}&
    \num{1390}&
    \num{401}&
    \num{109.5}&
    \num{28.2}&
    \num{7.1}\\
    $n = 17$&
    \num{1862145}&
    \num{1.7e+05}&
    \num{984}&
    \num{298}&
    \num{86.5}&
    \num{24.2}&
    \num{6.8}\\
    \bottomrule
  \end{tabular}
  \caption{%
    For $d = 10$:
    Grid size of the interior grid
    $\interior{\Omega}_{n,d}^\sparse$ for \emph{(second column)}
    and ratios
    $|\Omega_{n,d}^{\sparse(b)}|/|\interior{\Omega}_{n,d}^\sparse|$
    \emph{(beginning with third column)} of the sizes of
    the grid $\Omega_{n,d}^{\sparse(b)}$ with boundary points
    to the size of the interior grid of the same level.
    The table begins at the first level $n = 10$ for which
    the interior grid $\interior{\Omega}_{n,d}^\sparse$ is not empty.%
  }
  \label{tbl:coarseBoundary10D}
\end{table}

\Cref{alg:coarseBoundary} shows how to generate the necessary set of
hierarchical levels.
Its correctness can be formally proved with the following invariant:
\begin{restatable}[invariant of \cref{alg:coarseBoundary}]{proposition}{%
  propInvariantCoarseBoundary%
}
  \label{prop:invariantCoarseBoundary}
  \label{PROP:INVARIANTCOARSEBOUNDARY}
  After iteration $t$ of \cref{alg:coarseBoundary}
  ($t = 1, \dotsc, d$), it holds
  \begin{equation}
    \label{eq:coarseInvariant}
    \begin{split}
      L^{(t)}
      &= \{\ßl \in \NN^t \mid \norm{\ßl}_1 \le n - d + t\} \dotcup {}\\
      &\hphantom{{}={}} \big(\{\ßl \in \NN_0^t \setminus \NN^t \mid
      \norm{\vecmax(\ßl, \ß1)}_1 \le n-d+t-b+1\} \cup \{\ß0\}\big).
    \end{split}
  \end{equation}
\end{restatable}
\begin{proof}
  See \cref{sec:proofInvariantCoarseBoundary}.
\end{proof}
\begin{shortcorollary}
  \Cref{alg:coarseBoundary} is correct.
\end{shortcorollary}
\begin{proof}
  Follows immediately from \cref{prop:invariantCoarseBoundary}
  by setting $t = d$.
\end{proof}

\begin{algorithm}
  \begin{algorithmic}[1]
    \Function{$L_{n,d}^{\sparse(b)} =$ computeSGCoarseBoundary}{%
      $n$, $d$, $b$%
    }
      \State{$L^{(1)} \gets \{0, 1, \dotsc, n - d + 1\}$}
      \For{$t = 2, \dotsc, d$}
        \State{$L^{(t)} \gets \emptyset$}
        \For{$\ßl \in L^{(t-1)}$}
          \If{%
            $\norm{\vecmax(\ßl, \ß1)}_1 \le n - d + t - b$ or
            $\ßl = \ß0$%
          }%
          \label{line:algCoarseBoundary1}
            \State{$L^{(t)} \gets L^{(t)} \cup \{(\ßl, 0)\}$}
            \label{line:algCoarseBoundary5}
          \EndIf{}
          \If{$\ßl \in \NN^{t-1}$}
            \State{$l^\ast \gets n - d + t - \norm{\ßl}_1$}%
            \label{line:algCoarseBoundary2}
          \Else{}
            \State{%
              $l^\ast \gets n - d + t - b + 1 -
              \norm{\vecmax(\ßl, \ß1)}_1$%
            }%
            \label{line:algCoarseBoundary3}
          \EndIf{}
          \State{%
            $L^{(t)} \gets L^{(t)} \cup
            \{(\ßl, l_t) \mid l_t = 1, \dotsc, l^\ast\}$%
          }
          \label{line:algCoarseBoundary4}
        \EndFor{}
      \EndFor{}
      \State{\Return{$L^{(d)}$}}
    \EndFunction{}
  \end{algorithmic}
  \caption{%
    Generation of the level set $L_{n,d}^{\sparse(b)}$ corresponding
    to the sparse grid $\Omega_{n,d}^{\sparse(b)}$ with coarse boundaries.
    Inputs are the level $n \ge d$, the dimensionality $d \in \NN$, and
    the boundary parameter $b \in \NN$.%
  }
  \label{alg:coarseBoundary}
\end{algorithm}

\begin{figure}
  \subcaptionbox{%
    $d = 2$, $b = 0$%
  }[35mm]{%
    \includegraphics{coarseBoundary_1}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 2$, $b = 1$%
  }[35mm]{%
    \includegraphics{coarseBoundary_2}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 2$, $b = 2$%
  }[35mm]{%
    \includegraphics{coarseBoundary_3}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 2$, $b = 3$%
  }[35mm]{%
    \includegraphics{coarseBoundary_4}%
  }\\[2mm]%
  \subcaptionbox{%
    $d = 3$, $b = 0$%
  }[35mm]{%
    \includegraphics{coarseBoundary_5}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 3$, $b = 1$%
  }[35mm]{%
    \includegraphics{coarseBoundary_6}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 3$, $b = 2$%
  }[35mm]{%
    \includegraphics{coarseBoundary_7}%
  }%
  \hfill%
  \subcaptionbox{%
    $d = 3$, $b = 3$%
  }[35mm]{%
    \includegraphics{coarseBoundary_8}%
  }%
  \caption{%
    Sparse grids $\Omega_{n,d}^{\sparse(b)}$ of level $n = 3$
    in two and three dimensions for different values of the
    boundary parameter $b$.
    For constant $d$ and $n$,
    the points in the interior of $[\ß0, \ß1]$
    (black) are the same,
    while the points on the boundary of $[\ß0, \ß1]$
    \emph{\textcolor{mittelblau}{(blue)}} become coarser
    for increasing values of $b$.
    For reasons of clarity, the grid points on the
    bottom, left, and back faces of the three-dimensional cubes
    are not shown.
    The main axes (axis-parallel lines through $0.5 \cdot \ß1$, \emph{dashed})
    serve as a visual aid.%
  }
  \label{fig:coarseBoundary}
\end{figure}

\paragraph{Hierarchization}

An important implication of the regular sparse grids
$\Omega_{n,d}^{\sparse(b)}$ as defined in \cref{def:coarseBoundary}
is that in general,
the unidirectional principle cannot be directly applied anymore.
For example, this is relevant when calculating hierarchical surpluses
for the hat function basis.
As we mostly deal with B-splines, for which the unidirectional
principle cannot be applied even on regular sparse grids,
this issue is not important in the scope of this thesis.

However, it is possible to calculate the hierarchical surpluses in
a three-step algorithm.
\newgsymbol{Omegasd}{$\bndry{\Omega}^\sparse$}{%
  Boundary grid points $:= \Omega^\sparse \setminus \interior{\Omega}^\sparse$
  for a finite set $\Omega^\sparse \subset [\ß0, \ß1]$ of grid points%
}%
First, we compute the surpluses of the boundary grid
$\bndry{\Omega}_{n,d}^{\sparse(b)} :=
\Omega_{n,d}^{\sparse(b)} \setminus \interior{\Omega}_{n,d}^{\sparse(b)}$.
Second, we subtract the values of the resulting ``boundary interpolant'' at
the inner grid points
$\interior{\Omega}_{n,d}^{\sparse(b)}$.
Third, we calculate the surpluses of the inner grid points
as usual with the unidirectional principle.
As the corresponding ``inner interpolant'' vanishes
on the boundary, this does not influence the interpolated values in step~1.

\subsection{Sparse Grids Without Boundary Points and Modified Bases}

\paragraph{Omitting boundary points}

The second solution to reduce the number of grid points on the boundary
is to omit boundary points and basis functions altogether.
For the hat function basis $\varphi_{\ßl,\ßi}^1$,
this is a feasible option if the objective
function $f\colon [\ß0, \ß1] \to \RR$
satisfies homogeneous boundary conditions $f_{\bndry{[\ß0, \ß1]}} \equiv 0$,
as $\varphi_{\ßl,\ßi}^1$ vanishes on the boundary if and only if
$\lnot(\ßl \ge \ß1)$, i.e., if the basis function corresponds to a
boundary point.
Consequently, the surpluses corresponding to boundary points vanish
for a grid with boundary points,
implying that these points can be removed from the grid.

\paragraph{Modified linear basis}

Of course, this approach is not viable for functions with non-zero
boundary values or general hierarchical bases,
making it necessary to change the basis.
For hat functions, Pflüger modified the leftmost and rightmost
univariate basis function of each level (with indices $i = 1$ and
$i = 2^l - 1$ respectively) such that the modified functions
extrapolate the inner values linearly towards the boundary
\cite{Pflueger10Spatially}.
The basis function on level $1$ is replaced by the
``constant $1$'' function.
All other basis functions remain unchanged.
\newgsymbol{.mod}{$\cdot^\modified$}{%
  Superscript for ``Modified (basis function/function space/interpolant)
  for grids without boundary points''%
}%
The resulting \term{modified hat functions} $\varphi_{l,i}^{1,\modified}$
are defined as follows:
\begin{equation}
  \varphi_{l,i}^{1,\modified}(x)
  :=
  \begin{cases}
    1,&
    l = 1,\quad i = 1,\\
    \max(2 - x/h_l, 0),&
    l \ge 2,\quad i = 1,\\
    \varphi_{l,i}^1(x),&
    l \ge 2,\quad i \in I_l \setminus \{1, 2^l - 1\},\\
    \varphi_{l,1}^{1,\modified}(1 - x),&
    l \ge 2,\quad i = 2^l - 1.
  \end{cases}
\end{equation}
The modified linear basis, which can be seen in \cref{fig:modifiedHat},
provides ``reasonable'' boundary values
without the need to insert basis functions and grid points on the boundary.
For other bases such as B-splines, similar modifications are possible,
which we will discuss when we introduce the corresponding unmodified functions.

\begin{figure}
  \includegraphics{hierarchicalHat_3}%
  \caption{Modified hierarchical hat functions of level $l' = 1, 2, 3$.}
  \label{fig:modifiedHat}
\end{figure}
